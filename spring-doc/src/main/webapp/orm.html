<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>14.&nbsp;&#23545;&#35937;&#20851;&#31995;&#26144;&#23556;(ORM)&#25968;&#25454;&#35775;&#38382;</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Framework Reference Documentation"><link rel="up" href="spring-data-tier.html" title="Part&nbsp;IV.&nbsp;&#25968;&#25454;&#35775;&#38382;"><link rel="prev" href="jdbc.html" title="13.&nbsp;Data access with JDBC"><link rel="next" href="oxm.html" title="15.&nbsp;Marshalling XML using O/X Mappers"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">14.&nbsp;&#23545;&#35937;&#20851;&#31995;&#26144;&#23556;(ORM)&#25968;&#25454;&#35775;&#38382;</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="jdbc.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;IV.&nbsp;&#25968;&#25454;&#35775;&#38382;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="oxm.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="orm" href="#orm"></a>14.&nbsp;&#23545;&#35937;&#20851;&#31995;&#26144;&#23556;(ORM)&#25968;&#25454;&#35775;&#38382;</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orm-introduction" href="#orm-introduction"></a>14.1&nbsp;&#20171;&#32461; Spring &#20013;&#30340; ORM</h2></div></div></div>

<p>Spring Framework &#25903;&#25345;&#38598;&#25104;  Hibernate, Java Persistence API (JPA) &#21644; Java Data Objects (JDO) &#29992;&#20110;&#36164;&#28304;&#31649;&#29702;&#12289;&#25968;&#25454;&#35775;&#38382;&#23545;&#35937;(DAO)&#30340;&#23454;&#29616;,&#21644;&#20107;&#21153;&#31574;&#30053;&#12290;&#20363;&#22914;,&#23545;&#20110; Hibernate &#26377;&#19968;&#27969;&#30340;&#25903;&#25345;&#65292;&#20351;&#29992;&#26041;&#20415;&#30340; IoC &#29305;&#24615;,&#35299;&#20915;&#35768;&#22810;&#20856;&#22411;&#30340; Hibernate &#38598;&#25104;&#38382;&#39064;&#12290;&#24744;&#21487;&#20197;&#36890;&#36807;&#20381;&#36182;&#27880;&#20837;&#37197;&#32622;&#30340;&#25152;&#26377;  O/R (&#23545;&#35937;&#20851;&#31995;) &#26144;&#23556;&#24037;&#20855;&#30340;&#29305;&#24615;&#12290;&#20182;&#20204;&#21487;&#20197;&#21442;&#19982; Spring &#30340;&#36164;&#28304;&#21644;&#20107;&#21153;&#31649;&#29702;,&#20182;&#20204;&#31526;&#21512; Spring &#30340;&#36890;&#29992;&#20107;&#21153;&#21644; DAO &#24322;&#24120;&#23618;&#27425;&#32467;&#26500;&#12290;&#24314;&#35758;&#38598;&#25104;&#39118;&#26684;&#26159;&#22312; Hibernate, JPA, &#21644; JDO APIs &#20013;&#20351;&#29992; DAO &#12290;&#26087;&#30340; Spring DAO &#27169;&#26495;&#19981;&#20877;&#25512;&#33616;&#20351;&#29992;;&#28982;&#32780;,&#20851;&#20110;&#39118;&#26684;&#30340;&#35770;&#36848;&#21487;&#20197;&#35265;
<a class="xref" href="classic-spring.html#classic-spring-orm" title="31.1&nbsp;Classic ORM usage">Section&nbsp;31.1, &#8220;Classic ORM usage&#8221;</a> .</p>
<p>&#24403;&#20320;&#21019;&#24314;&#25968;&#25454;&#35775;&#38382;&#24212;&#29992;&#26102;&#65292;Spring &#33021;&#23545;&#20320;&#36873;&#25321;&#30340; ORM &#23618;&#36827;&#34892;&#26174;&#30528;&#30340;&#22686;&#24378;&#12290;&#20320;&#26681;&#25454;&#20320;&#30340;&#38656;&#27714;&#36827;&#34892;&#23613;&#21487;&#33021;&#22810;&#30340;&#38598;&#25104;&#25903;&#25345;&#65292;&#21516;&#26102;&#38656;&#35201;&#27604;&#36825;&#31181;&#25972;&#21512;&#22312;&#24314;&#19968;&#20010;&#31867;&#20284;&#30340;&#22522;&#30784;&#35774;&#26045;&#26102;&#30340;&#20869;&#37096;&#39118;&#38505;&#12290;&#36890;&#36807;&#24211;&#65292;&#20320;&#21487;&#20197;&#20351;&#29992;&#24456;&#22810;&#30340; ORM &#30340;&#25903;&#25345;&#65292;&#19981;&#29992;&#31649;&#25216;&#26415;&#65292;&#22240;&#20026;&#19968;&#20999;&#37117;&#26159;&#35774;&#35745;&#25104;&#19968;&#32452;&#21487;&#37325;&#29992;&#30340; JavaBean&#12290;ORM &#22312; Spring IoC &#23481;&#22120;&#20415;&#20110;&#37197;&#32622;&#21644;&#37096;&#32626;&#12290;&#22240;&#27492;&#65292;&#26412;&#25991;&#20013;&#30340;&#22823;&#22810;&#25968;&#31034;&#20363;&#37197;&#32622;&#26174;&#31034;&#22312; Spring &#23481;&#22120;&#37324;&#12290;</p>
<p>&#20351;&#29992; Spring Framework &#26469;&#21019;&#24314;&#24744;&#30340; ORM DAO &#22909;&#22788;&#21253;&#25324;:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>&#26356;&#23481;&#26131;&#27979;&#35797;.</em></span> Spring &#30340; IoC &#26041;&#27861;&#20415;&#20110;&#20132;&#25442;&#23454;&#29616;&#21644;&#37197;&#32622; Hibernate <code class="literal">SessionFactory</code> &#23454;&#20363;,JDBC <code class="literal">DataSource</code>(&#25968;&#25454;&#28304;)&#23454;&#20363;,&#20107;&#21153;&#31649;&#29702;,&#20197;&#21450;&#26144;&#23556;&#23545;&#35937;&#23454;&#29616;(&#22914;&#26524;&#38656;&#35201;)&#12290;&#36825;&#21453;&#36807;&#26469;&#20351;&#20854;&#26356;&#23481;&#26131;&#38548;&#31163;&#27979;&#35797;&#27599;&#19968;&#22359;&#25345;&#32493;&#30456;&#20851;&#20195;&#30721;&#12290;
</li><li class="listitem">
<span class="emphasis"><em>&#24120;&#35265;&#30340;&#25968;&#25454;&#35775;&#38382;&#24322;&#24120;.</em></span> Spring &#21487;&#20197;&#20174;&#20320;&#30340; ORM &#24037;&#20855;&#21253;&#35013;&#24322;&#24120;,&#23558;&#20182;&#20204;&#20174;&#19987;&#26377;&#30340;(&#21487;&#33021;&#26816;&#26597;)&#24322;&#24120;&#36716;&#20026;&#20849;&#21516;&#36816;&#34892;&#26102; DataAccessException &#23618;&#27425;&#12290;&#36825;&#20010;&#29305;&#24615;&#20801;&#35768;&#24744;&#22788;&#29702;&#22823;&#22810;&#25968;&#25345;&#20037;&#21270;&#30340;&#24322;&#24120;&#19981;&#21487;&#24674;&#22797;&#30340;&#65292;&#32780;&#19988;&#21482;&#20986;&#29616;&#22312;&#36866;&#24403;&#30340;&#23618;,&#27809;&#26377;&#24700;&#20154;&#30340;&#25429;&#25417;&#12289;&#25243;&#20986;&#12289;&#21644;&#24322;&#24120;&#22768;&#26126;&#12290;&#24403;&#28982;&#26681;&#25454;&#38656;&#35201;&#20320;&#20173;&#28982;&#21487;&#20197;&#25429;&#33719;&#21644;&#22788;&#29702;&#24322;&#24120;&#12290;&#35760;&#20303;,JDBC &#24322;&#24120;(&#21253;&#25324;&#25968;&#25454;&#24211;&#29305;&#27530;&#30340;&#26041;&#35328;)&#20063;&#36716;&#25442;&#20026;&#30456;&#21516;&#30340;&#23618;&#27425;&#32467;&#26500;,&#36825;&#24847;&#21619;&#30528;&#24744;&#21487;&#20197;&#22312;&#20351;&#29992; JDBC &#25191;&#34892;&#19968;&#20123;&#25805;&#20316;&#26102;&#25317;&#26377;&#19968;&#33268;&#30340;&#32534;&#31243;&#27169;&#22411;&#12290;
</li><li class="listitem">
<span class="emphasis"><em>&#36890;&#29992;&#36164;&#28304;&#31649;&#29702;.</em></span> Spring &#24212;&#29992;&#31243;&#24207;&#19978;&#19979;&#25991;&#21487;&#20197;&#22788;&#29702;&#30340;&#23450;&#20301;&#21644;&#37197;&#32622;Hibernate <code class="literal">SessionFactory</code> &#23454;&#20363;,JPA <code class="literal">EntityManagerFactory</code>&#23454;&#20363;,JDBC <code class="literal">DataSource</code>(&#25968;&#25454;&#28304;)&#23454;&#20363;,&#21644;&#20854;&#20182;&#30456;&#20851;&#36164;&#28304;&#12290;&#36825;&#20351;&#24471;&#36825;&#20123;&#20540;&#26131;&#20110;&#31649;&#29702;&#21644;&#25913;&#21464;&#12290;Spring &#25552;&#20379;&#20102;&#39640;&#25928;&#12289;&#31616;&#21333;&#21644;&#23433;&#20840;&#22788;&#29702;&#25345;&#20037;&#24615;&#30340;&#36164;&#28304;&#12290;&#20363;&#22914;,&#20851;&#32852;&#20195;&#30721;&#26469;&#20351;&#29992; Hibernate &#65292;&#36890;&#24120;&#38656;&#35201;&#20351;&#29992;&#30456;&#21516;&#30340; Hibernate <code class="literal">Session</code>,&#20197;&#30830;&#20445;&#39640;&#25928;&#21644;&#36866;&#24403;&#30340;&#20107;&#21153;&#22788;&#29702;&#12290;Spring &#24456;&#23481;&#26131;&#21019;&#24314;&#21644;&#36879;&#26126;&#22320;&#23558;<code class="literal">Session</code>&#32465;&#23450;&#21040;&#24403;&#21069;&#32447;&#31243;,&#36890;&#36807;&#20351;&#29992; Hibernate <code class="literal">SessionFactory</code> &#26469;&#26292;&#38706;&#20986;&#24403;&#21069;<code class="literal">Session</code>&#12290;&#22240;&#27492;&#65292;&#38024;&#23545;&#20219;&#20309;&#26412;&#22320;&#25110; JTA &#20107;&#21153;&#29615;&#22659;&#65292;Spring &#35299;&#20915;&#35768;&#22810;&#22312;&#20856;&#22411;&#30340; Hibernate &#20351;&#29992;&#20013;&#30340;&#24815;&#24615;&#38382;&#39064;&#12290;
</li><li class="listitem">
<span class="emphasis"><em>&#38598;&#25104;&#20107;&#21153;&#31649;&#29702;.</em></span> &#21487;&#20197;&#36890;&#36807;&#22768;&#26126;&#24335;&#30340;,&#38754;&#21521;&#26041;&#38754;&#30340;&#32534;&#31243;(AOP)&#39118;&#26684;&#26041;&#27861;&#25318;&#25130;&#22120;&#21253;&#35013;&#20320;&#30340; ORM &#20195;&#30721;&#36890;&#36807;&#21527;&#65292;&#21487;&#20197;&#37319;&#29992;<code class="literal">@Transactional</code>&#27880;&#37322;&#25110;&#36890;&#36807;&#26174;&#24335;&#37197;&#32622;&#20107;&#21153; AOP advice &#22312;&#19968;&#20010; XML &#37197;&#32622;&#25991;&#20214;&#20013;&#12290;&#22312;&#36825;&#20004;&#31181;&#24773;&#20917;&#19979;,&#37117;&#26159;&#21487;&#20197;&#20026;&#24744;&#22788;&#29702;&#20107;&#21153;&#35821;&#20041;&#21644;&#24322;&#24120;&#22788;&#29702;(&#22238;&#28378;,&#31561;&#31561;)&#12290;&#22914;&#19979;&#38754;&#25152;&#35752;&#35770;&#30340;
<a class="link" href="orm.html#orm-resource-mngmnt" title="14.2.1&nbsp;&#36164;&#28304;&#21644;&#20107;&#21153;&#31649;&#29702;">Resource and transaction management</a>, &#20320;&#20063;&#21487;&#20197;&#20132;&#25442;&#19981;&#21516;&#30340;&#20107;&#21153;&#31649;&#29702;&#22120;,&#32780;&#19981;&#24433;&#21709; ORM &#30456;&#20851;&#30340;&#20195;&#30721;&#12290;&#20363;&#22914;,&#24744;&#21487;&#20197;&#22312;&#30456;&#21516;&#30340;&#20840;&#38754;&#26381;&#21153;(&#22914;&#22768;&#26126;&#24615;&#20107;&#21153;)&#30340;&#20004;&#20010;&#22330;&#26223;&#65292;&#23454;&#29616;&#26412;&#22320;&#20107;&#21153;&#21644; JTA &#20043;&#38388;&#20132;&#25442;&#12290;&#21478;&#22806;,JDBC &#30456;&#20851;&#30340;&#20195;&#30721;&#21487;&#20197;&#23436;&#20840;&#38598;&#25104;&#20107;&#21153;&#21040;&#20320;&#20351;&#29992;&#30340; ORM &#20195;&#30721;&#20013;&#12290;&#36825;&#26159;&#23545;&#20110;&#25968;&#25454;&#35775;&#38382;&#26377;&#29992;,&#20294;&#19981;&#36866;&#21512; ORM &#20013;&#30340;&#25209;&#22788;&#29702;&#21644; BLOB &#27969;&#31561;,&#36825;&#20173;&#28982;&#38656;&#35201;&#22312;ORM&#25805;&#20316; &#20132;&#25442;&#20849;&#21516;&#30340;&#20107;&#21153;&#12290;
</li></ul></div>

<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>&#20026;&#26356;&#20840;&#38754;&#20102;&#35299;&#30340; ORM &#30340;&#25903;&#25345;,&#21253;&#25324;&#25903;&#25345;&#26367;&#20195;&#25968;&#25454;&#24211;&#25216;&#26415;,&#22914; MongoDB &#25968;&#25454;&#24211;,&#24744;&#21487;&#33021;&#24076;&#26395;&#26597;&#30475;
<a class="ulink" href="http://projects.spring.io/spring-data/" target="_top">Spring Data</a> &#37197;&#22871;&#30340;&#39033;&#30446;&#12290;&#22914;&#26524;&#20320;&#26159;&#19968;&#20010; JPA &#29992;&#25143; <a class="ulink" href="https://spring.io/guides/gs/accessing-data-jpa/" target="_top">Getting Started Accessing
Data with JPA</a> &#25552;&#20379;&#20102;&#19968;&#20010;&#24456;&#22909;&#30340;&#20171;&#32461;.</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orm-general" href="#orm-general"></a>14.2&nbsp;&#24120;&#35265;&#30340; ORM &#38598;&#25104;&#26041;&#38754;&#30340;&#27880;&#24847;&#20107;&#39033;</h2></div></div></div>

<p>&#26412;&#33410;&#24378;&#35843;&#30340; &#27880;&#24847;&#20107;&#39033;&#24212;&#29992;&#19982;&#25152;&#26377;&#30340; ORM &#25216;&#26415;&#12290;
<a class="xref" href="orm.html#orm-hibernate" title="14.3&nbsp;Hibernate">Section&nbsp;14.3, &#8220;Hibernate&#8221;</a> &#36825;&#33410;&#25552;&#20379;&#20102;&#26356;&#22810;&#32454;&#33410;&#65292;&#21516;&#26102;&#23637;&#31034;&#20102;&#36825;&#20123;&#29305;&#24615;&#21644;&#20855;&#20307;&#19978;&#19979;&#25991;&#30340;&#37197;&#32622;&#12290;</p>
<p>Spring &#30340; ORM &#38598;&#25104;&#30340;&#20027;&#35201;&#30446;&#26631;&#26159;&#26126;&#30830;&#30340;&#24212;&#29992;&#31243;&#24207;&#20998;&#23618;,&#21253;&#25324;&#22312;&#20219;&#20309;&#25968;&#25454;&#35775;&#38382;&#12289;&#20107;&#21153;&#25216;&#26415;&#21644;&#26494;&#32806;&#21512;&#30340;&#24212;&#29992;&#31243;&#24207;&#23545;&#35937;&#12290;&#27809;&#26377;&#26356;&#22810;&#30340;&#19994;&#21153;&#26381;&#21153;&#20381;&#36182;&#20110;&#25968;&#25454;&#35775;&#38382;&#25110;&#20107;&#21153;&#31574;&#30053;,&#19981;&#20877;&#36164;&#28304;&#26597;&#25214;&#30828;&#32534;&#30721;,&#19981;&#20877;&#24378;&#21046;&#26367;&#25442;&#21333;&#20363;,&#27809;&#26377;&#26356;&#22810;&#30340;&#33258;&#23450;&#20041;&#26381;&#21153;&#27880;&#20876;&#12290;&#19968;&#20010;&#31616;&#21333;&#30340;&#21644;&#19968;&#33268;&#30340;&#26041;&#27861;&#26469;&#36830;&#25509;&#24212;&#29992;&#31243;&#24207;&#23545;&#35937;,&#35753;&#20182;&#20204;&#23613;&#21487;&#33021;&#30340;&#23545;&#23481;&#22120;&#20381;&#36182;&#26159;&#21487;&#20197;&#37325;&#29992;&#24182;&#19988;&#26159;&#33258;&#30001;&#12290;&#25152;&#26377;&#20010;&#20154;&#25968;&#25454;&#35775;&#38382;&#29305;&#24615;&#21487;&#29992;&#30340;,&#20294;&#21487;&#20197;&#19982;Spring &#24212;&#29992;&#31243;&#24207;&#19978;&#19979;&#25991;&#30340;&#27010;&#24565;&#38598;&#25104;,&#25552;&#20379;&#22522;&#20110; xml &#30340;&#37197;&#32622;&#21644;&#20132;&#21449;&#24341;&#29992;&#30340;&#26222;&#36890; JavaBean &#23454;&#20363;&#32780;&#19981;&#38656;&#35201; Spring-aware&#65288;Spring &#30340;&#24847;&#35782;&#65289;&#12290;&#22312;&#19968;&#20010;&#20856;&#22411;&#30340; Spring &#24212;&#29992;&#31243;&#24207;&#20013;,&#35768;&#22810;&#37325;&#35201;&#30340;&#23545;&#35937;&#26159; JavaBean:&#25968;&#25454;&#35775;&#38382;&#27169;&#26495;,&#25968;&#25454;&#35775;&#38382;&#23545;&#35937;,&#20107;&#21153;&#31649;&#29702;&#22120;,&#20351;&#29992;&#25968;&#25454;&#35775;&#38382;&#23545;&#35937;&#21644;&#20107;&#21153;&#31649;&#29702;&#22120;&#30340;&#19994;&#21153;&#26381;&#21153;, web &#35270;&#22270;&#35299;&#26512;&#22120;,&#20351;&#29992;&#19994;&#21153;&#26381;&#21153;&#30340; web &#25511;&#21046;&#22120;,&#31561;&#31561;&#12290;</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-resource-mngmnt" href="#orm-resource-mngmnt"></a>14.2.1&nbsp;&#36164;&#28304;&#21644;&#20107;&#21153;&#31649;&#29702;</h3></div></div></div>

<p>&#20856;&#22411;&#30340;&#21830;&#19994;&#24212;&#29992;&#26159;&#29992;&#37325;&#22797;&#30340;&#36164;&#28304;&#31649;&#29702;&#20195;&#30721;&#26434;&#20081;&#30340;&#22534;&#31215;&#36215;&#26469;&#30340;&#12290;&#24456;&#22810;&#39033;&#30446;&#35797;&#22270;&#21019;&#36896;&#33258;&#24049;&#30340;&#35299;&#20915;&#26041;&#26696;&#65292;&#26377;&#26102;&#20026;&#20102;&#32534;&#31243;&#26041;&#20415;&#26469;&#29306;&#29298;&#25925;&#38556;&#30340;&#22788;&#29702;&#12290;Spring &#25552;&#20513;&#31616;&#21333;&#30340;&#22788;&#29702;&#36866;&#24403;&#36164;&#28304;&#30340;&#26041;&#26696;&#65292;&#21363;&#22312;JDBC&#30340;&#26696;&#20363; IoC &#36890;&#36807;&#27169;&#26495;&#21644;&#22312; ORM &#25216;&#26415;&#24212;&#29992; AOP &#25318;&#25130;&#22120;&#12290;</p>
<p>&#22522;&#30784;&#35774;&#26045;&#25552;&#20379;&#36866;&#24403;&#30340;&#36164;&#28304;&#22788;&#29702;&#65292;&#24182;&#19988;&#33021;&#23558;&#29305;&#23450;&#30340; API &#24322;&#24120;&#36866;&#24403;&#30340;&#36716;&#25442;&#20026;&#19968;&#20010;&#26410;&#26816;&#26597;&#30340;&#22522;&#30784;&#30340;&#24322;&#24120;&#23618;&#27425;&#32467;&#26500;&#12290;Spring  &#24341;&#20837;&#20102; DAO &#24322;&#24120;&#23618;&#27425;&#32467;&#26500;&#65292;&#36866;&#29992;&#20110;&#20219;&#20309;&#30340;&#25968;&#25454;&#35775;&#38382;&#31574;&#30053;&#12290;&#23545;&#20110;&#30452;&#25509;&#30340; JDBC&#65292;&#22312;&#21069;&#19968;&#33410;&#25552;&#21040;&#30340;<code class="literal">JdbcTemplate</code>&#31867;&#25552;&#20379;&#20102;&#36830;&#25509;&#22788;&#29702;&#21644;&#23558; <code class="literal">SQLException</code> &#36866;&#24403;&#30340;&#36716;&#25442;&#20026;<code class="literal">DataAccessException</code> &#23618;&#27425;&#32467;&#26500;&#65292;&#20854;&#20013;&#21253;&#25324;&#23558; &#20855;&#20307;&#25968;&#25454;&#24211; SQL &#38169;&#35823;&#20195;&#30721;&#36716;&#20026;&#26377;&#24847;&#20041;&#30340;&#24322;&#24120;&#31867;&#12290;&#23545;&#20110; ORM &#25216;&#26415;&#65292;&#35265;&#19979;&#19968;&#33410;&#65292;&#22914;&#20309;&#24471;&#21040;&#30456;&#21516;&#24322;&#24120;&#36716;&#25442;&#30340;&#22909;&#22788;&#12290;</p>
<p>&#24403;&#28041;&#21450;&#21040;&#20107;&#21153;&#31649;&#29702;&#65292;<code class="literal">JdbcTemplate</code>&#31867;&#19982; Spring &#30340;&#20107;&#21153;&#25903;&#25345;&#25346;&#38057;&#65292;&#24182;&#19988;&#36890;&#36807;&#21508;&#33258;&#30340; Spring &#20107;&#21153;&#31649;&#29702;&#22120;&#25903;&#25345; JTA &#21644; JDBC &#20107;&#21153;&#12290;&#20026;&#25903;&#25345; ORM &#25216;&#26415; Spring &#25552;&#20379;&#20102;&#36890;&#36807;&#19982; JTA &#25903;&#25345;&#31867;&#20284;&#30340; Hibernate&#65292;JPA&#65292;&#21644; JDO &#20107;&#21153;&#31649;&#29702;&#22120;&#26469;&#23454;&#29616;&#23545; Hibernate&#65292;JPA &#21644; JDO &#25903;&#25345;&#12290;&#26356;&#22810;&#20107;&#21153;&#30340;&#25903;&#25345;&#65292;&#35814;&#32454;&#20449;&#24687;&#65292;&#21442; <a class="xref" href="transaction.html" title="11.&nbsp;&#20107;&#21153;&#31649;&#29702;">Chapter&nbsp;11, <i>&#20107;&#21153;&#31649;&#29702;</i></a> chapter.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-exception-translation" href="#orm-exception-translation"></a>14.2.2&nbsp;&#24322;&#24120;&#36716;&#21270;</h3></div></div></div>

<p>&#24403;&#20320;&#22312; DAO &#20013;&#20351;&#29992; Hibernate&#12289;JPA &#25110; JDO &#26102;,&#20320;&#24517;&#39035;&#20915;&#23450;&#22914;&#20309;&#22788;&#29702;&#25345;&#20037;&#21270;&#25216;&#26415;&#30340;&#21407;&#29983;&#24322;&#24120;&#31867;&#12290;&#36816;&#29992;&#19981;&#21516;&#30340;&#25216;&#26415;&#65292;DAO &#20250;&#25243;&#20986;<code class="literal">HibernateException</code>&#12289;<code class="literal">PersistenceException</code>&#25110;<code class="literal">JDOException</code> &#30340;&#23376;&#31867;&#12290;&#36825;&#20123;&#24322;&#24120;&#37117;&#26159;&#36816;&#34892;&#26102;&#30340;&#24322;&#24120;,&#19981;&#38656;&#35201;&#22768;&#26126;&#25110;&#25429;&#33719;&#12290;&#20320;&#21487;&#33021;&#24517;&#39035;&#22788;&#29702;<code class="literal">IllegalArgumentException</code> &#21644;<code class="literal">IllegalStateException</code>&#12290;&#36825;&#24847;&#21619;&#30528;&#35843;&#29992;&#32773;&#21482;&#33021;&#23558;&#24322;&#24120;&#22788;&#29702;&#25104;&#20026;&#19968;&#20010;&#36890;&#24120;&#20026;&#33268;&#21629;&#30340;&#38382;&#39064;,&#38500;&#38750;&#20182;&#20204;&#24819;&#35201;&#20381;&#36182;&#20110;&#25345;&#20037;&#21270;&#25216;&#26415;&#33258;&#36523;&#30340;&#24322;&#24120;&#32467;&#26500;&#12290;&#25429;&#25417;&#20048;&#35266;&#38145;&#23450;&#22833;&#36133;&#31561;&#20855;&#20307;&#21407;&#22240;&#26159;&#19981;&#21487;&#33021;&#30340;&#38500;&#38750;&#25226;&#35843;&#29992;&#32773;&#19982;&#23454;&#29616;&#31574;&#30053;&#30456;&#32852;&#31995;&#12290;&#21462;&#28040;&#36825;&#20132;&#25442;&#26159;&#21487;&#25509;&#21463;&#30340;&#23545;&#20110;&#24212;&#29992;&#31243;&#24207;&#26159;&#22522;&#20110; ORM &#21644;/&#25110; &#19981;&#38656;&#35201;&#20219;&#20309;&#29305;&#27530;&#30340;&#24322;&#24120;&#22788;&#29702;&#12290;&#28982;&#32780;,Spring &#36890;&#36807; <code class="literal">@Repository</code> &#27880;&#35299; &#26469;&#20351;&#24322;&#24120;&#36879;&#26126;&#30340;&#36716;&#21270;:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Repository</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-comment">// class body here...</span>

}</pre>

<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-comment">&lt;!-- Exception translation bean post processor --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.dao.annotation.PersistenceExceptionTranslationPostProcessor"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>postprocessor &#20250;&#33258;&#21160;&#23547;&#25214;&#25152;&#26377;&#24322;&#24120;&#36716;&#25442;&#22120;( &#23454;&#29616; <code class="literal">PersistenceExceptionTranslator</code> &#25509;&#21475;),&#24314;&#35758;&#25152;&#26377; bean &#26631;&#26377;<code class="literal">@Repository</code>&#27880;&#35299;,&#20197;&#20415;&#21457;&#29616;&#30340;&#36716;&#25442;&#22120;&#21487;&#20197;&#22312;&#25243;&#20986;&#24322;&#24120;&#26102;&#25318;&#25130;&#21644;&#24212;&#29992;&#36866;&#24403;&#30340;&#36716;&#25442;&#12290;</p>
<p>&#24635;&#20043;:&#24744;&#21487;&#20197;&#23454;&#29616; DAO  &#22522;&#20110;&#32431;&#25345;&#20037;&#21270;&#25216;&#26415;&#30340;API&#21644;&#27880;&#35299;,&#21516;&#26102;&#20173;&#28982;&#21463;&#30410;&#20110;Spring &#31649;&#29702;&#20107;&#21153;,&#20381;&#36182;&#27880;&#20837;&#12289;&#21644;&#36879;&#26126;&#23558;&#24322;&#24120;&#36716;&#25442;(&#22914;&#26524;&#38656;&#35201;)&#20026; Spring &#30340;&#33258;&#23450;&#20041;&#30340;&#24322;&#24120;&#23618;&#27425;&#32467;&#26500;&#12290;</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orm-hibernate" href="#orm-hibernate"></a>14.3&nbsp;Hibernate</h2></div></div></div>

<p>&#29616;&#22312;&#35201;&#24320;&#22987;&#35848;&#19979; Spring &#29615;&#22659;&#20013;&#30340;  <a class="ulink" href="http://www.hibernate.org/" target="_top">Hibernate 3</a> &#29992;&#23427;&#26469;&#23637;&#31034; Spring &#23545;&#38598;&#25104; O/R &#26144;&#23556;&#30340;&#26041;&#27861;&#12290;&#26412;&#33410;&#23558;&#35814;&#32454;&#35752;&#35770;&#35768;&#22810;&#38382;&#39064;,&#24182;&#26174;&#31034;&#19981;&#21516;&#30340; DAO &#23454;&#29616;&#21644;&#20107;&#21153;&#30028;&#23450;&#12290;&#22823;&#22810;&#25968;&#36825;&#20123;&#27169;&#24335;&#21487;&#20197;&#30452;&#25509;&#20174;&#25152;&#26377;&#20854;&#20182;&#25903;&#25345; ORM &#30340;&#24037;&#20855;&#20013;&#36716;&#25442;&#12290;&#20197;&#19979;&#37096;&#20998;&#22312;&#26412;&#31456;&#23558;&#35206;&#30422;&#20854;&#20182;&#30340; ORM &#25216;&#26415;,&#24182;&#26174;&#31034;&#31616;&#30701;&#30340;&#20363;&#23376;&#12290;</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>&#23545;&#20110;Spring 4.0, Spring &#38656;&#35201; Hibernate 3.6 &#25110;&#32773;&#26356;&#39640;&#29256;&#26412;</p>
</td></tr></table></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-session-factory-setup" href="#orm-session-factory-setup"></a>14.3.1&nbsp;&#22312; Spring &#23481;&#22120;&#20013;&#35774;&#32622; SessionFactory</h3></div></div></div>

<p>&#20026;&#20102;&#36991;&#20813;&#24212;&#29992;&#31243;&#24207;&#23545;&#35937;&#19982;&#30828;&#32534;&#30721;&#30340;&#36164;&#28304;&#26597;&#25214;&#24819;&#32465;&#23450;&#65292;&#24744;&#21487;&#20197;&#23450;&#20041;&#36164;&#28304;&#22914; JDBC <code class="literal">DataSource</code> &#25110;&#32773; Hibernate <code class="literal">SessionFactory</code> &#20026; Spring &#23481;&#22120;&#30340; bean&#12290;&#24212;&#29992;&#23545;&#35937;&#38656;&#35201;&#36890;&#36807;&#23545; bean &#30340;&#24341;&#29992;&#26469;&#35775;&#38382;&#36164;&#28304;&#25509;&#21463;&#24341;&#29992;&#65292;&#23601;&#22914;&#22312;&#19979;&#19968;&#33410;&#20013;&#35828;&#26126;&#30340; DAO &#30340;&#23450;&#20041;&#12290;</p>
<p>&#20197;&#19979;&#25688;&#24405;&#33258; XML &#24212;&#29992;&#31243;&#24207;&#19978;&#19979;&#25991;&#23450;&#20041;&#65292;&#23637;&#31034;&#20102;&#22914;&#20309;&#35774;&#32622; JDBC <code class="literal">DataSource</code> &#25110;&#32773; Hibernate <code class="literal">SessionFactory</code> :</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myDataSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverClassName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.hsqldb.jdbcDriver"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdbc:hsqldb:hsql://localhost:9001"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"sa"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">""</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mySessionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myDataSource"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappingResources"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>product.hbm.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"hibernateProperties"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>
                hibernate.dialect=org.hibernate.dialect.HSQLDialect
            <span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#20174; Jakarta Commons DBCP <code class="literal">BasicDataSource</code> &#36716;&#20026; JNDI-located <code class="literal">DataSource</code>, &#20027;&#35201;&#30340;&#37197;&#32622;&#20026;&#65306;</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myDataSource"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"java:comp/env/jdbc/myds"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#24744;&#36824;&#21487;&#20197;&#35775;&#38382; JNDI-located <code class="literal">SessionFactory</code>,&#20351;&#29992; Spring &#30340;<code class="literal">JndiObjectFactoryBean</code>/<code class="literal">&lt;jee:jndi-lookup&gt;</code> &#26469;&#26816;&#32034;&#21644;&#26292;&#38706;&#20182;&#12290;&#28982;&#32780;,&#36890;&#24120;&#22312; EJB &#29615;&#22659;&#22806;&#19981;&#24120;&#29992;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-hibernate-straight" href="#orm-hibernate-straight"></a>14.3.2&nbsp;&#22522;&#20110;&#24179;&#24120;&#30340; Hibernate 3 API &#26469;&#23454;&#29616; DAO</h3></div></div></div>

<p>Hibernate 3 &#26377;&#19968;&#20010;&#29305;&#24615;&#31216;&#20026;&#19978;&#19979;&#25991;&#20250;&#35805;,Hibernate &#26412;&#36523;&#22312;&#27599;&#20010;&#20107;&#21153;&#31649;&#29702;&#19968;&#20010;&#24403;&#21069; <code class="literal">Session</code> &#12290;&#36825;&#26159;&#22823;&#33268;&#30456;&#24403;&#20110; Spring &#30340; &#27599;&#20010;&#20107;&#21153;&#19968;&#20010;&#24403;&#21069; Hibernate <code class="literal">Session</code>&#30340;&#21516;&#27493;&#12290;&#30456;&#24212;&#30340; DAO &#23454;&#29616;&#20687;&#19979;&#38754;&#30340;&#20363;&#23376;,&#22522;&#20110;&#26222;&#36890;Hibernate API</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">private</span> SessionFactory sessionFactory;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setSessionFactory(SessionFactory sessionFactory) {
        <span class="hl-keyword">this</span>.sessionFactory = sessionFactory;
    }

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.sessionFactory.getCurrentSession()
                .createQuery(<span class="hl-string">"from test.Product product where product.category=?"</span>)
                .setParameter(<span class="hl-number">0</span>, category)
                .list();
    }
}</pre>

<p>&#36825;&#31181;&#39118;&#26684;&#31867;&#20284;&#20110; Hibernate &#21442;&#32771;&#25991;&#26723;&#21644;&#20363;&#23376;,&#38500;&#20102;&#22312;&#19968;&#20010;&#23454;&#20363;&#21464;&#37327;&#20013;&#20445;&#23384; <code class="literal">SessionFactory</code>&#12290;&#25105;&#20204;&#24378;&#28872;&#24314;&#35758;&#22522;&#20110;&#23454;&#20363;&#30340;&#35774;&#32622;,&#26367;&#25442;&#32769;&#27966;&#30340;Hibernate &#30340; CaveatEmptor &#31034;&#20363;&#24212;&#29992;&#31243;&#24207;&#20013;&#30340;<code class="literal">static</code> <code class="literal">HibernateUtil</code>&#31867;&#12290;(&#19968;&#33324;&#26469;&#35828;,&#19981;&#20445;&#30041;&#20219;&#20309;&#36164;&#28304;<code class="literal">static</code>&#21464;&#37327;,&#38500;&#38750;&#32477;&#23545;&#24517;&#35201;)</p>
<p>&#19978;&#38754;&#30340; DAO &#26159;&#20381;&#36182;&#27880;&#20837;&#27169;&#24335;:&#36825;&#27491;&#22909;&#31526;&#21512; Spring IoC &#23481;&#22120;,&#23601;&#20687;&#23545;Spring &#30340; <code class="literal">HibernateTemplate</code> &#32534;&#30721;&#12290;&#24403;&#28982;,&#36825;&#31181; DAO &#20063;&#21487;&#20197;&#22312;&#26222;&#36890;&#30340; Java &#35774;&#32622;(&#20363;&#22914;,&#22312;&#21333;&#20803;&#27979;&#35797;)&#12290;&#31616;&#21333;&#30340;&#23454;&#20363;&#21270;,&#24182;&#29992;&#25152;&#38656;&#30340;&#24037;&#21378;&#24341;&#29992;&#35843;&#29992;<code class="literal">setSessionFactory(..)</code>&#12290;Spring bean &#23450;&#20041; DAO &#23601;&#20687;&#19979;&#38754;&#19968;&#26679;:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mySessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>DAO &#39118;&#26684;&#30340;&#20027;&#35201;&#20248;&#28857;&#26159;&#65292;&#23427;&#21482;&#20381;&#36182;&#20110; Hibernate API &#65292;&#32780;&#27809;&#26377;&#24341;&#36827;&#20219;&#20309;Spring &#24517;&#38656;&#30340;&#31867;&#12290;&#20174;&#38750;&#20405;&#20837;&#24615;&#30340;&#35270;&#35282;&#30475;&#36825;&#24403;&#28982;&#26159;&#26377;&#21560;&#24341;&#21147;&#30340;&#65292;&#23545;Hibernate &#24320;&#21457;&#32773;&#26469;&#35828;&#26080;&#30097;&#20250;&#24863;&#35273;&#26356;&#33258;&#28982;&#12290;</p>
<p>&#28982;&#32780;&#65292;DAO &#23558;&#24179;&#24120;&#30340; <code class="literal">HibernateException</code>&#65288;&#36825;&#26159;&#26410;&#26816;&#26597;&#30340;&#65292;&#25152;&#20197;&#19981;&#38656;&#35201;&#22768;&#26126;&#25110;&#32773;&#25429;&#33719;&#65289;&#65292;&#36825;&#24847;&#21619;&#30528;&#35843;&#29992;&#32773;&#24403;&#24322;&#24120;&#20026;&#19968;&#20010;&#26222;&#36890;&#30340;&#33268;&#21629;&#38382;&#39064;&#8212;&#8212;&#38500;&#38750;&#20182;&#20204;&#24819;&#35201;&#20381;&#36182;&#20110; Hibernate &#33258;&#36523;&#30340;&#24322;&#24120;&#32467;&#26500;&#12290;&#25429;&#25417;&#20048;&#35266;&#38145;&#23450;&#22833;&#36133;&#31561;&#20855;&#20307;&#21407;&#22240;&#26159;&#19981;&#21487;&#33021;&#38500;&#38750;&#25226;&#35843;&#29992;&#32773;&#19982;&#23454;&#29616;&#31574;&#30053;&#30456;&#32852;&#31995;&#12290;&#21462;&#28040;&#36825;&#20132;&#25442;&#26159;&#21487;&#25509;&#21463;&#30340;&#23545;&#20110;&#24212;&#29992;&#31243;&#24207;&#26159;&#22522;&#20110; Hibernate &#21644;/&#25110; &#19981;&#38656;&#35201;&#20219;&#20309;&#29305;&#27530;&#30340;&#24322;&#24120;&#22788;&#29702;&#12290;</p>
<p>&#24184;&#36816;&#30340;&#26159;,Spring &#30340; <code class="literal">LocalSessionFactoryBean</code> &#25903;&#25345; Hibernate <code class="literal">SessionFactory.getCurrentSession()</code>&#26041;&#27861;&#29992;&#20110;&#20219;&#20309; Spring &#20107;&#21153;&#31574;&#30053;,&#36820;&#22238;&#24403;&#21069; Spring &#31649;&#29702;&#30340;&#20107;&#21153; <code class="literal">Session</code>&#21363;&#20351;&#26159;<code class="literal">HibernateTransactionManager.</code>&#12290;&#24403;&#28982;,&#36825;&#31181;&#26041;&#27861;&#30340;&#26631;&#20934;&#34892;&#20026;&#36820;&#22238;&#20173;&#28982;&#26159;&#24403;&#21069;<code class="literal">Session</code>&#19982;&#25345;&#32493;&#30340;JTA&#20107;&#21153;&#26377;&#20851;&#12290;&#36825;&#31181;&#34892;&#20026;&#36866;&#29992;&#20110;&#19981;&#31649;&#24744;&#20351;&#29992;&#26159;Spring &#30340; <code class="literal">JtaTransactionManager</code>,EJB&#23481;&#22120;&#31649;&#29702;&#30340;&#20107;&#21153;(CMT),&#25110; JTA&#12290;</p>
<p>&#24635;&#20043;:&#20320;&#21487;&#20197;&#22522;&#20110;&#24179;&#24120;&#30340; Hibernate 3 API &#26469;&#23454;&#29616; DAO,&#21516;&#26102;&#20173;&#28982;&#33021;&#22815;&#21442;&#19982; Spring &#31649;&#29702;&#20107;&#21153;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-hibernate-tx-declarative" href="#orm-hibernate-tx-declarative"></a>14.3.3&nbsp;&#22768;&#26126;&#24335;&#20107;&#21153;&#21010;&#20998;</h3></div></div></div>

<p>&#24314;&#35758;&#20320;&#20351;&#29992; Spring &#22768;&#26126;&#24335;&#20107;&#21153;&#30340;&#25903;&#25345;,&#36825;&#20351;&#24744;&#33021;&#22815;&#20195;&#26367;&#26174;&#24335;&#20107;&#21153;&#21010;&#20998; API&#35843;&#29992; AOP &#20107;&#21153;&#25318;&#25130;&#22120;&#20013;&#30340; Java &#20195;&#30721;&#12290;&#36825;&#20010;&#20107;&#21153;&#25318;&#25130;&#22120;&#21487;&#20197;&#37197;&#32622; Spring&#23481;&#22120;&#36890;&#36807;&#20351;&#29992; Java &#27880;&#37322;&#25110; XML&#12290;&#36825;&#20010;&#22768;&#26126;&#24335;&#20107;&#21153;&#33021;&#21147;&#20801;&#35768;&#24744;&#20445;&#25345;&#19994;&#21153;&#26381;&#21153;&#20013;&#30340;&#37325;&#22797;&#24615;&#20107;&#21153;&#21010;&#20998;&#20195;&#30721;&#30721;&#26356;&#33258;&#30001;&#65292;&#24182;&#19988;&#35753;&#20320;&#21482;&#20851;&#27880;&#28155;&#21152;&#19994;&#21153;&#36923;&#36753;,&#32780;&#36825;&#26159;&#24744;&#30340;&#24212;&#29992;&#31243;&#24207;&#30340;&#30495;&#27491;&#20215;&#20540;&#12290;</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>&#22312;&#32487;&#32493;&#20043;&#21069;&#65292;&#24378;&#28872;&#24314;&#35758;&#20320;&#35835;<a class="xref" href="transaction.html#transaction-declarative" title="11.5&nbsp;Declarative transaction management">Section&nbsp;11.5, &#8220;Declarative transaction management&#8221;</a>
&#22914;&#26524;&#20320;&#36824;&#27809;&#26377;&#36825;&#26679;&#20570;</p>
</td></tr></table></div>

<p>&#27492;&#22806;&#65292;&#20107;&#21153;&#35821;&#20041;&#27604;&#22914;&#20256;&#25773;&#34892;&#20026;&#21644;&#38548;&#31163;&#27700;&#24179;&#21487;&#20197;&#22312;&#37197;&#32622;&#25991;&#20214;&#30340;&#25913;&#21464;&#65292;&#19981;&#24433;&#21709;&#19994;&#21153;&#26381;&#21153;&#30340;&#23454;&#29616;&#12290;</p>
<p>&#19979;&#38754;&#30340;&#31034;&#20363;&#35828;&#26126;&#22914;&#20309;&#20351;&#29992; XML &#37197;&#32622; AOP &#20107;&#21153;&#25318;&#25130;&#22120;&#65292;&#19968;&#20010;&#31616;&#21333;&#30340;&#26381;&#21153;&#31867;&#65306;</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- SessionFactory, DataSource, etc. omitted --&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;aop:config&gt;</span>
        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"productServiceMethods"</span>
                <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* product.ProductService.*(..))"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"productServiceMethods"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/aop:config&gt;</span>

    <span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"myTxManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;tx:attributes&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"increasePrice*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someOtherBusinessMethod"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRES_NEW"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"SUPPORTS"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/tx:attributes&gt;</span>
    <span class="hl-tag">&lt;/tx:advice&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.SimpleProductService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"productDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myProductDao"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#19979;&#38754;&#26159;&#35201;&#22788;&#29702;&#30340;&#26381;&#21153;&#31867;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductServiceImpl <span class="hl-keyword">implements</span> ProductService {

    <span class="hl-keyword">private</span> ProductDao productDao;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setProductDao(ProductDao productDao) {
        <span class="hl-keyword">this</span>.productDao = productDao;
    }

    <span class="hl-comment">// notice the absence of transaction demarcation code in this method</span>
    <span class="hl-comment">// Spring's declarative transaction infrastructure will be demarcating</span>
    <span class="hl-comment">// transactions on your behalf</span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> increasePriceOfAllProductsInCategory(<span class="hl-keyword">final</span> String category) {
        List productsToChange = <span class="hl-keyword">this</span>.productDao.loadProductsByCategory(category);
        <span class="hl-comment">// ...</span>
    }
}</pre>

<p>&#25105;&#20204;&#36824;&#23637;&#31034;&#20102;&#19968;&#20010;&#22522;&#20110;&#37197;&#32622;&#23646;&#24615;&#30340;&#25903;&#25345;&#65292;&#22312;&#19979;&#38754;&#30340;&#20363;&#23376;&#20013;&#12290;&#20320;&#36890;&#36807; <code class="literal">@Transactional</code>&#27880;&#37322;&#30340;&#26381;&#21153;&#23618;,&#24182;&#24341;&#23548; Spring &#23481;&#22120;&#25214;&#21040;&#36825;&#20123;&#27880;&#37322;&#65292;&#36825;&#20123;&#27880;&#37322;&#30340;&#26041;&#27861;&#25552;&#20379;&#20107;&#21153;&#24615;&#35821;&#20041;&#12290;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductServiceImpl <span class="hl-keyword">implements</span> ProductService {

    <span class="hl-keyword">private</span> ProductDao productDao;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setProductDao(ProductDao productDao) {
        <span class="hl-keyword">this</span>.productDao = productDao;
    }

    <em><span class="hl-annotation" style="color: gray">@Transactional</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> increasePriceOfAllProductsInCategory(<span class="hl-keyword">final</span> String category) {
        List productsToChange = <span class="hl-keyword">this</span>.productDao.loadProductsByCategory(category);
        <span class="hl-comment">// ...</span>
    }

    <em><span class="hl-annotation" style="color: gray">@Transactional(readOnly = true)</span></em>
    <span class="hl-keyword">public</span> List&lt;Product&gt; findAllProducts() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.productDao.findAllProducts();
    }

}</pre>

<p>&#27491;&#22914;&#20320;&#21487;&#20197;&#30475;&#21040;&#19979;&#38754;&#30340;&#37197;&#32622;&#23454;&#20363;&#65292;&#37197;&#32622;&#26356;&#21152;&#31616;&#21270;&#65292;&#19982;&#19978;&#36848; XML &#23454;&#20363;&#65292;&#21516;&#26102;&#36824;&#25552;&#20379;&#20102;&#22312;&#26381;&#21153;&#23618;&#30340;&#20195;&#30721;&#27880;&#37322;&#39537;&#21160;&#30456;&#21516;&#30340;&#21151;&#33021;&#12290;&#25152;&#26377;&#24744;&#38656;&#35201;&#25552;&#20379;&#30340;&#26159;TransactionManager &#30340;&#23454;&#29616;&#21644;"&lt;tx:annotation-driven/&gt;" &#23454;&#20307;</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- SessionFactory, DataSource, etc. omitted --&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;tx:annotation-driven/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.SimpleProductService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"productDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myProductDao"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-hibernate-tx-programmatic" href="#orm-hibernate-tx-programmatic"></a>14.3.4&nbsp;&#32534;&#31243;&#24335;&#20107;&#21153;&#21010;&#20998;</h3></div></div></div>

<p>&#21487;&#20197;&#22312;&#39640;&#32423;&#30340;&#24212;&#29992;&#20013;&#21010;&#20998;&#20107;&#21153;&#65292;&#22312;&#36825;&#26679;&#30340;&#24213;&#23618;&#25968;&#25454;&#35775;&#38382;&#26381;&#21153;&#29983;&#25104;&#20219;&#24847;&#25968;&#37327;&#30340;&#25805;&#20316;&#12290;&#38480;&#21046;&#20063;&#19981;&#23384;&#22312;&#20110;&#21608;&#36793;&#19994;&#21153;&#26381;&#21153;&#30340;&#23454;&#29616;;&#23427;&#21482;&#38656;&#35201;&#19968;&#20010; Spring <code class="literal">PlatformTransactionManager</code>&#12290;&#20877;&#27425;,&#21518;&#32773;&#21487;&#20197;&#26469;&#33258;&#20219;&#20309;&#22320;&#26041;,&#20294;&#26368;&#22909;&#26159;&#36890;&#36807; <code class="literal">setTransactionManager(..)</code>&#26041;&#27861;&#26469;&#23545; bean &#24341;&#29992;,&#27491;&#22914;&#30001;<code class="literal">setProductDao(..)</code>&#26041;&#27861;&#26469;&#35774;&#32622; <code class="literal">productDAO</code>&#12290;&#19979;&#38754;&#30340;&#20195;&#30721;&#29255;&#27573;&#26174;&#31034;&#20102;&#22312;Spring &#24212;&#29992;&#31243;&#24207;&#19978;&#19979;&#25991;&#20013;&#23450;&#20041;&#19968;&#20010;&#20107;&#21153;&#31649;&#29702;&#22120;&#21644;&#19994;&#21153;&#26381;&#21153;,&#20197;&#21450;&#19968;&#20010;&#19994;&#21153;&#26041;&#27861;&#23454;&#29616;:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTxManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mySessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myTxManager"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"productDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myProductDao"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductServiceImpl <span class="hl-keyword">implements</span> ProductService {

    <span class="hl-keyword">private</span> TransactionTemplate transactionTemplate;
    <span class="hl-keyword">private</span> ProductDao productDao;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setTransactionManager(PlatformTransactionManager transactionManager) {
        <span class="hl-keyword">this</span>.transactionTemplate = <span class="hl-keyword">new</span> TransactionTemplate(transactionManager);
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setProductDao(ProductDao productDao) {
        <span class="hl-keyword">this</span>.productDao = productDao;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> increasePriceOfAllProductsInCategory(<span class="hl-keyword">final</span> String category) {
        <span class="hl-keyword">this</span>.transactionTemplate.execute(<span class="hl-keyword">new</span> TransactionCallbackWithoutResult() {
            <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> doInTransactionWithoutResult(TransactionStatus status) {
                List productsToChange = <span class="hl-keyword">this</span>.productDao.loadProductsByCategory(category);
                <span class="hl-comment">// do the price increase...</span>
            }
        });
    }
}</pre>

<p>Spring <code class="literal">TransactionInterceptor</code> &#20801;&#35768;&#20219;&#20309;&#26816;&#26597;&#30340;&#24212;&#29992;&#24322;&#24120;&#21487;&#20197;&#36319;&#30528;&#22238;&#35843;&#20195;&#30721;&#25243;&#20986;&#65292;&#32780; <code class="literal">TransactionTemplate</code>&#26159;&#38480;&#21046;&#20110;&#26410;&#26816;&#26597;&#30340;&#22238;&#35843;&#30340;&#24322;&#24120;&#12290;&#24403;&#36935;&#21040;&#19968;&#20010;&#26410;&#26816;&#26597;&#30340;&#24212;&#29992;&#24322;&#24120;&#25110;&#32773;&#26159;&#20107;&#21153;&#34987;&#24212;&#29992;&#65288;&#36890;&#36807;<code class="literal">TransactionStatus</code>&#65289;&#26631;&#35760;&#20026; rollback-only&#65288;&#21482;&#22238;&#28378;&#65289; ,<code class="literal">TransactionTemplate</code>&#35302;&#21457;&#22238;&#28378;&#20107;&#21153;&#12290;&#40664;&#35748;&#26102; <code class="literal">TransactionInterceptor</code>&#34920;&#29616;&#26159;&#19968;&#26679;&#30340;&#65292;&#20294;&#26159;&#20801;&#35768;&#22312;&#27599;&#20010;&#26041;&#27861;&#20013;&#37197;&#32622;&#22238;&#28378;&#31574;&#30053;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-hibernate-tx-strategies" href="#orm-hibernate-tx-strategies"></a>14.3.5&nbsp;&#20107;&#21153;&#31649;&#29702;&#31574;&#30053;</h3></div></div></div>

<p><code class="literal">TransactionTemplate</code> &#21644; <code class="literal">TransactionInterceptor</code>&#20195;&#34920;&#20102;&#23545; <code class="literal">PlatformTransactionManager</code> &#23454;&#20363;&#30340;&#23454;&#38469;&#20107;&#21153;&#22788;&#29702;&#65292;&#22312; Hibernate &#30340;&#24212;&#29992;&#20013;&#23427;&#20204;&#21487;&#20197;&#26159;&#19968;&#20010; <code class="literal">HibernateTransactionManager</code>&#65288;&#19968;&#20010;Hibernate &#30340; <code class="literal">SessionFactory</code>&#65292;&#22312;&#24341;&#25806;&#19979;&#20351;&#29992;&#30340;&#26159;<code class="literal">ThreadLocal</code> <code class="literal">Session</code>&#65289;&#25110; <code class="literal">JtaTransactionManager</code>&#65288;&#22996;&#27966;&#21040;&#23481;&#22120;&#30340; JTA &#23376;&#31995;&#32479;&#65289;&#12290;&#20320;&#29978;&#33267;&#21487;&#20197;&#20351;&#29992;&#19968;&#20010;&#33258;&#23450;&#20041;&#30340;<code class="literal">PlatformTransactionManager</code> &#23454;&#29616;&#12290;&#20174;&#21407;&#29983; Hibernate &#20107;&#21153;&#31649;&#29702; &#36716;&#21040; JTA&#65292;&#22914;&#20320;&#30340;&#26576;&#20123;&#24212;&#29992;&#31243;&#24207;&#37096;&#32626;&#20855;&#26377;&#20998;&#24067;&#24335;&#20107;&#21153;&#22788;&#29702;&#30340;&#35201;&#27714;&#65292;&#37027;&#20040;&#36825;&#20165;&#20165;&#26159;&#19968;&#20010;&#37197;&#32622;&#30340;&#38382;&#39064;&#65292;&#21482;&#35201;&#23558; Hibernate &#20107;&#21153;&#31649;&#29702;&#31616;&#21333;&#30340;&#26367;&#25442;&#20026; Spring &#30340; JTA &#21363;&#21487;&#12290;&#20004;&#20010;&#30340;&#20107;&#21153;&#21010;&#20998;&#21644;&#25968;&#25454;&#35775;&#38382;&#20195;&#30721;&#30340;&#19981;&#29992;&#25913;&#21464;&#65292;&#22240;&#20026;&#20182;&#20204;&#21482;&#26159;&#20351;&#29992;&#20102;&#36890;&#29992;&#30340;&#20107;&#21153;&#31649;&#29702; API&#12290;</p>
<p>&#23545;&#20110;&#20998;&#24067;&#24335;&#20107;&#21153;&#36328;&#22810;&#20010; Hibernate &#20250;&#35805;&#24037;&#21378;&#65292;&#21482;&#35201;&#31616;&#21333;&#22320;&#25226;<code class="literal">JtaTransactionManager</code> &#19982;&#20855;&#26377;&#22810;&#20010;&#23450;&#20041;&#30340;<code class="literal">LocalSessionFactoryBean</code>&#32452;&#21512;&#25104;&#20026;&#19968;&#20010;&#20107;&#21153;&#31574;&#30053;&#12290;&#27599;&#20010; DAO &#24471;&#21040;&#19968;&#20010;&#29305;&#23450;&#30340;<code class="literal">SessionFactory</code>&#30340;&#24341;&#29992;&#20256;&#36882;&#21040;&#20854;&#30456;&#24212;&#30340; bean &#23646;&#24615;&#12290;&#22914;&#26524;&#25152;&#26377;&#24213;&#23618;&#30340; JDBC &#25968;&#25454;&#28304;&#30340;&#20107;&#21153;&#23481;&#22120;&#65292;&#19994;&#21153;&#26381;&#21153;&#21487;&#20197;&#21010;&#20998;&#20107;&#21153;&#21040;&#20219;&#24847;&#25968;&#37327;&#30340;DAO &#21644;&#20219;&#20309;&#25968;&#37327;&#30340;&#20250;&#35805;&#24037;&#21378;&#65292;&#32780;&#36825;&#26080;&#38656;&#27809;&#26377;&#29305;&#27530;&#30340;&#22788;&#29702;&#65292;&#21482;&#35201;&#26159;&#20351;&#29992;<code class="literal">JtaTransactionManager</code>&#31574;&#30053;&#12290;</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource1"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"java:comp/env/jdbc/myds1"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource2"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"java:comp/env/jdbc/myds2"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mySessionFactory1"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myDataSource1"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappingResources"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>product.hbm.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"hibernateProperties"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>
                hibernate.dialect=org.hibernate.dialect.MySQLDialect
                hibernate.show_sql=true
            <span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mySessionFactory2"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myDataSource2"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mappingResources"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;list&gt;</span>
                <span class="hl-tag">&lt;value&gt;</span>inventory.hbm.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;/list&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"hibernateProperties"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>
                hibernate.dialect=org.hibernate.dialect.OracleDialect
            <span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTxManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.jta.JtaTransactionManager"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mySessionFactory1"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myInventoryDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.InventoryDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"mySessionFactory2"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"productDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myProductDao"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"inventoryDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myInventoryDao"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;aop:config&gt;</span>
        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"productServiceMethods"</span>
                <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* product.ProductService.*(..))"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"productServiceMethods"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/aop:config&gt;</span>

    <span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"myTxManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;tx:attributes&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"increasePrice*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someOtherBusinessMethod"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRES_NEW"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"SUPPORTS"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/tx:attributes&gt;</span>
    <span class="hl-tag">&lt;/tx:advice&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p><code class="literal">HibernateTransactionManager</code> &#21644; <code class="literal">JtaTransactionManager</code>&#20801;&#35768;&#36866;&#24403;&#30340; JVM &#32423;&#21035;&#30340; Hibernate &#32531;&#23384;&#22788;&#29702;,&#32780;&#19981;&#38656;&#35201;&#23481;&#22120;&#29305;&#23450;&#30340;&#20107;&#21153;&#31649;&#29702;&#26597;&#25214;&#25110; JCA &#36830;&#25509;&#22120;(&#22914;&#26524;&#20320;&#19981;&#20351;&#29992; EJB &#21551;&#21160;&#20107;&#21153;)&#12290;</p>
<p><code class="literal">HibernateTransactionManager</code>&#21487;&#20197;&#20026;&#19968;&#20010;&#29305;&#23450;&#30340;<code class="literal">DataSource</code>&#23548;&#20986; Hibernate JDBC <code class="literal">Connection</code>&#21040;&#26222;&#36890; JDBC &#35775;&#38382;&#20195;&#30721;&#12290;&#27492;&#21151;&#33021;&#20801;&#35768;&#39640;&#32423;&#30340;&#28151;&#21512; Hibernate &#21644; JDBC &#25968;&#25454;&#35775;&#38382;&#30340;&#23436;&#20840;&#27809;&#26377; JTA &#30340;&#20107;&#21153;&#21010;&#20998;,&#22914;&#26524;&#20320;&#21482;&#35775;&#38382;&#19968;&#20010;&#25968;&#25454;&#24211;&#12290;&#22914;&#26524;&#20320;&#26377;&#35774;&#32622;&#36890;&#36807; <code class="literal">LocalSessionFactoryBean</code>&#31867;&#30340;<code class="literal">dataSource</code>&#23646;&#24615;&#20256;&#20837;<code class="literal">SessionFactory</code>&#30340;<code class="literal">DataSource</code>&#65292;<code class="literal">HibernateTransactionManager</code>&#33258;&#21160;&#26292;&#38706; Hibernate &#20107;&#21153;&#20316;&#20026;&#19968;&#20010; JDBC &#20107;&#21153;&#12290;&#25110;&#32773;,&#24744;&#21487;&#20197;&#26126;&#30830;&#25351;&#23450;<code class="literal">DataSource</code>&#20013;&#21738;&#20123;&#20107;&#21153;&#26159;&#38656;&#35201;&#25903;&#25345;&#36890;&#36807; HibernateTransactionManager &#31867;&#30340;<code class="literal">dataSource</code>&#23646;&#24615;&#26292;&#38706;&#30340;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-hibernate-resources" href="#orm-hibernate-resources"></a>14.3.6&nbsp;&#27604;&#36739;&#23481;&#22120;&#31649;&#29702;&#21644;&#26412;&#22320;&#23450;&#20041;&#30340;&#36164;&#28304;</h3></div></div></div>

<p>&#20320;&#21487;&#20197;&#22312;&#19968;&#20010;&#23481;&#22120;&#31649;&#29702;&#30340; JNDI <code class="literal">SessionFactory</code>&#21644;&#26412;&#22320;&#23450;&#20041;&#30340;&#20114;&#30456;&#20999;&#25442;,&#32780;&#26080;&#38656;&#26356;&#25913;&#24212;&#29992;&#31243;&#24207;&#30340;&#20195;&#30721;&#12290;&#26159;&#21542;&#20445;&#25345;&#36164;&#28304;&#23450;&#20041;&#22312;&#23481;&#22120;&#25110;&#26412;&#22320;&#24212;&#29992;&#31243;&#24207;&#20013;&#65292;&#20027;&#35201;&#21462;&#20915;&#20110;&#20351;&#29992;&#30340;&#20107;&#21153;&#31574;&#30053;&#12290;&#23545;&#27604; Spring &#23450;&#20041;&#30340;&#26412;&#22320;&#30340;<code class="literal">SessionFactory</code>,&#25163;&#21160;&#27880;&#20876; JNDI <code class="literal">SessionFactory</code>&#27809;&#26377;&#20219;&#20309;&#22909;&#22788;&#12290;&#37096;&#32626;&#19968;&#20010;&#36890;&#36807; Hibernate JCA &#36830;&#25509;&#22120;&#30340;<code class="literal">SessionFactory</code>&#26469;&#25552;&#20379; Java EE &#26381;&#21153;&#22120;&#30340;&#31649;&#29702;&#22522;&#30784;&#35774;&#26045;&#30340;&#38468;&#21152;&#20540;,&#20294;&#22312;&#36825;&#20043;&#21069;&#19981;&#22686;&#21152;&#20219;&#20309;&#23454;&#38469;&#30340;&#20540;&#12290;</p>
<p>Spring &#30340;&#20107;&#21153;&#25903;&#25345;&#19981;&#26159;&#32465;&#23450;&#21040;&#19968;&#20010;&#23481;&#22120;&#20013;&#12290;&#22312;&#37197;&#32622;&#38500;&#20102; JTA &#20197;&#22806;&#30340;&#20219;&#20309;&#31574;&#30053;&#21518;&#65292;&#20107;&#21153;&#25903;&#25345;&#21516;&#26679;&#20063;&#33021;&#22312;&#19968;&#20010;&#29420;&#31435;&#30340;&#25110;&#27979;&#35797;&#30340;&#29615;&#22659;&#20013;&#24037;&#20316;&#12290;&#29305;&#21035;&#26159;&#22312;&#21333;&#29420;&#30340;&#25968;&#25454;&#24211;&#20107;&#21153;&#30340;&#20856;&#22411;&#24212;&#29992;&#20013;&#12290;Spring &#26159;&#19968;&#20010;&#36731;&#37327;&#32423;&#30340;&#21333;&#36164;&#28304;&#26412;&#22320;&#20107;&#21153;&#25903;&#25345;&#21644;&#24378;&#22823;&#30340; JTA &#30340;&#26367;&#20195;&#21697;&#12290;&#24403;&#20320;&#20351;&#29992;&#26412;&#22320; EJB &#26080;&#29366;&#24577;&#20250;&#35805; bean &#26469;&#39537;&#21160;&#20107;&#21153;,&#20320;&#37117;&#24517;&#39035;&#35201;&#20381;&#36182; EJB &#23481;&#22120;&#21644; JTA,&#21363;&#20351;&#20320;&#21482;&#35775;&#38382;&#19968;&#20010;&#25968;&#25454;&#24211;,&#24182;&#19988;&#21482;&#20351;&#29992;&#26080;&#29366;&#24577;&#20250;&#35805; bean &#36890;&#36807;&#23481;&#22120;&#31649;&#29702;&#30340;&#20107;&#21153;&#26469;&#25552;&#20379;&#22768;&#26126;&#24335;&#20107;&#21153;&#12290;&#21478;&#22806;,&#30452;&#25509;&#20351;&#29992; JTA &#32534;&#31243;&#38656;&#35201;&#19968;&#20010; Java EE &#29615;&#22659;&#12290;JTA &#24182;&#19981;&#21482;&#28041;&#21450;&#23481;&#22120;&#20381;&#36182;&#24615;&#30340;JTA &#26412;&#36523;&#21644; JNDI <code class="literal">DataSource</code> &#23454;&#20363;&#12290;&#23545;&#20110; &#38750; Spring,JTA &#39537;&#21160;&#30340; Hibernate &#20107;&#21153;&#20132;&#26131;,&#24744;&#24517;&#39035;&#20351;&#29992; Hibernate JCA &#36830;&#25509;&#22120;,&#25110;&#39069;&#22806;&#30340;Hibernate &#20107;&#21153;&#20195;&#30721;<code class="literal">TransactionManagerLookup</code>&#20026;&#36866;&#24403;&#30340; JVM &#32423;&#21035;&#37197;&#32622;&#32531;&#23384;&#12290;</p>
<p>Spring &#39537;&#21160;&#20107;&#21153;&#21487;&#20197;&#19982;&#26412;&#22320;&#23450;&#20041;&#30340; Hibernate <code class="literal">SessionFactory</code>&#21644;&#26412;&#22320;&#30340;JDBC <code class="literal">DataSource</code>&#24456;&#22909;&#30340;&#24037;&#20316;&#65292;&#22914;&#26524;&#20182;&#20204;&#35775;&#38382;&#19968;&#20010;&#25968;&#25454;&#24211;&#12290;&#22240;&#27492;&#20320;&#21482;&#38656;&#35201;&#20351;&#29992; Spring &#30340; JTA &#20107;&#21153;&#31574;&#30053;&#65292;&#22312;&#24403;&#20320;&#26377;&#20998;&#24067;&#24335;&#20107;&#21153;&#30340;&#38656;&#27714;&#30340;&#26102;&#20505;&#12290;JCA &#36830;&#25509;&#22120;&#38656;&#35201;&#29305;&#23450;&#23481;&#22120;&#37096;&#32626;&#27493;&#39588;,&#26174;&#28982;&#39318;&#20808;&#38656;&#35201;&#30340;&#26159; JCA &#30340;&#25903;&#25345;&#12290;&#36825;&#20010;&#37197;&#32622;&#27604;&#37096;&#32626;&#19968;&#20010;&#31616;&#21333;&#30340; &#20351;&#29992;&#26412;&#22320;&#36164;&#28304;&#23450;&#20041;&#21644; Spring &#39537;&#21160;&#20107;&#21153; web &#24212;&#29992;&#31243;&#24207;&#38656;&#35201;&#26356;&#22810;&#30340;&#24037;&#20316;&#12290;&#21516;&#26679;,&#20320;&#32463;&#24120;&#38656;&#35201;&#20320;&#30340;&#23481;&#22120;&#26159;&#20351;&#29992;&#30340;&#26159;&#20225;&#19994;&#29256;,&#20363;&#22914;,WebLogic Express, &#24182;&#19988;&#26159;&#19981;&#25552;&#20379; JCA&#12290;Spring &#30340;&#24212;&#29992;&#31243;&#24207;&#20855;&#26377;&#26412;&#22320;&#36164;&#28304;&#21644;&#20107;&#21153;&#36328;&#36234;&#25968;&#25454;&#24211;&#30340;&#33021;&#21147;&#65292;&#21487;&#20197;&#22312;&#20219;&#20309; Java EE web&#23481;&#22120;(&#27809;&#26377; JTA&#12289;JCA &#25110; EJB )&#22914;Tomcat&#12289;Resin&#12289;&#29978;&#33267;&#26222;&#36890;&#30340; Jetty &#20013;&#24037;&#20316;&#12290;&#27492;&#22806;,&#24744;&#21487;&#20197;&#24456;&#23481;&#26131;&#22320;&#37325;&#29992;&#36825;&#26679;&#30340;&#19968;&#20010;&#20013;&#38388;&#23618;&#22312;&#26700;&#38754;&#24212;&#29992;&#31243;&#24207;&#25110;&#27979;&#35797;&#22871;&#20214;&#20013;&#12290;</p>
<p>&#20174;&#20840;&#38754;&#32771;&#34385;,&#22914;&#26524;&#20320;&#19981;&#20351;&#29992; EJB,&#35831;&#22362;&#25345;&#20351;&#29992;&#26412;&#22320; <code class="literal">SessionFactory</code>&#35774;&#32622;&#21644; Spring &#30340;<code class="literal">HibernateTransactionManager</code>&#25110;<code class="literal">JtaTransactionManager</code>&#12290;&#20320;&#24471;&#21040;&#25152;&#26377;&#30340;&#22909;&#22788;,&#21253;&#25324;&#36866;&#24403;&#30340;&#20107;&#21153; JVM &#32423;&#21035;&#32531;&#23384;&#21644;&#20998;&#24067;&#24335;&#20107;&#21153;,&#27809;&#26377;&#23481;&#22120;&#37096;&#32626;&#30340;&#19981;&#20415;&#12290;JNDI &#36890;&#36807; JCA &#36830;&#25509;&#22120;&#27880;&#20876; Hibernate <code class="literal">SessionFactory</code>,&#22312;&#19982; EJB &#19968;&#36215;&#20351;&#29992;&#26102;&#21482;&#26159;&#22686;&#21152;&#20102;&#20540;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-hibernate-invalid-jdbc-access-error" href="#orm-hibernate-invalid-jdbc-access-error"></a>14.3.7&nbsp;&#22312; Hibernate &#20013;&#30340;&#34394;&#20551;&#24212;&#29992;&#26381;&#21153;&#22120;&#21578;&#35686;</h3></div></div></div>

<p>&#22312;&#19968;&#20123; JTA &#30340;&#38750;&#24120;&#20005;&#26684;&#30340; <code class="literal">XADataSource</code>&#23454;&#29616;&#30340;&#29615;&#22659;&#20013;&#8201;&#8212; &#30446;&#21069;&#21482;&#22312;&#19968;&#20123;  WebLogic Server &#21644; WebSphere &#29256;&#26412;&#20013;&#8201;&#8212; &#24403; Hibernate &#37197;&#32622;&#26102;&#27809;&#26377;&#30041;&#24847;&#29615;&#22659;&#20013;&#30340; JTA &#30340; <code class="literal">PlatformTransactionManager</code>&#23545;&#35937;&#65292;&#36825;&#21487;&#33021;&#20250;&#23548;&#33268; &#34394;&#20551;&#21578;&#35686;&#25110;&#32773;&#24322;&#24120;&#26174;&#31034;&#22312;&#24212;&#29992;&#26381;&#21153;&#22120;&#30340;&#26085;&#24535;&#20013;&#12290;&#36825;&#20123;&#21578;&#35686;&#25110;&#32773;&#24322;&#24120;&#26174;&#31034;&#36830;&#25509;&#35775;&#38382;&#19981;&#20877;&#26377;&#25928;,&#25110; JDBC &#35775;&#38382;&#19981;&#20877;&#26377;&#25928;,&#36825;&#21487;&#33021;&#26159;&#22240;&#20026;&#20107;&#21153;&#24050;&#32463;&#19981;&#20877;&#27963;&#21160;&#20102;&#12290;&#20030;&#20010;&#20363;&#23376;,&#36825;&#26159;&#19968;&#20010;&#30495;&#23454;&#30340; WebLogic &#24322;&#24120;:</p>

<pre class="literallayout">java.sql.SQLException: The transaction is no longer active - status: <span class="emphasis"><em>Committed</em></span>. No
further JDBC access is allowed within this transaction.</pre>

<p>&#35201;&#35299;&#20915;&#27492;&#35686;&#21578;&#65292;&#21482;&#38656;&#35201;&#20351; Hibernate &#30693;&#36947; JTA <code class="literal">PlatformTransactionManager</code>&#23454;&#20363;&#65292;&#23427;&#23558;&#21516;&#27493;&#65288;&#36830;&#21516; Spring&#65289;&#12290;&#23454;&#29616;&#36825;&#20010;&#26377;&#20004;&#20010;&#36873;&#39033;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
&#22914;&#26524;&#22312;&#20320;&#30340;&#24212;&#29992;&#31243;&#24207;&#19978;&#19979;&#25991;&#20013;&#20320;&#24050;&#32463;&#30452;&#25509;&#33719;&#21462; JTA <code class="literal">PlatformTransactionManager</code>&#23545;&#35937;&#65288;&#22823;&#27010;&#26159;&#20174; JNDI &#36890;&#36807;<code class="literal">JndiObjectFactoryBean</code> &#25110; <code class="literal">&lt;jee:jndi-lookup&gt;</code>&#65289;&#23558;&#23427;&#25552;&#20379;&#32473;&#65292;&#20363;&#22914;&#65292;Spring &#30340; <code class="literal">JtaTransactionManager</code>&#65292;&#37027;&#20040;&#26368;&#31616;&#21333;&#30340;&#26041;&#27861;&#26159;&#36890;&#36807;&#24341;&#29992;&#23450;&#20041;&#20102;&#36825;&#20010; JTA <code class="literal">PlatformTransactionManager</code>&#23454;&#20363;&#30340; bean&#32473;<code class="literal">LocalSessionFactoryBean</code>&#25351;&#23450;&#19968;&#20010;<code class="literal">jtaTransactionManager</code>&#30340;&#23646;&#24615;&#20540;&#12290;&#37027;&#20040; Spring &#23601;&#20250;&#20351;&#23545;&#35937;&#22312; Hibernate &#20013;&#21487;&#29992;
</li><li class="listitem">
&#20320;&#24456;&#26377;&#21487;&#33021;&#27809;&#26377; JTA <code class="literal">PlatformTransactionManager</code>&#23454;&#20363;&#65292;&#22240;&#20026;Spring &#30340; <code class="literal">JtaTransactionManager</code> &#26412;&#36523;&#21487;&#20197;&#25214;&#21040;&#23427;&#12290;&#22240;&#27492;&#65292;&#20320;&#38656;&#35201;&#37197;&#32622; Hibernate &#30452;&#25509;&#26597;&#25214; JTA <code class="literal">PlatformTransactionManager</code>&#12290;&#20320;&#21487;&#20197;&#22312; Hibernate &#37197;&#32622;&#20013;&#36890;&#36807;&#37197;&#32622;&#24212;&#29992;&#31243;&#24207;&#26381;&#21153;&#22120;&#29305;&#23450;&#30340;<code class="literal">ransactionManagerLookup</code>&#31867;&#23454;&#29616;&#36825;&#20010;&#65292;&#27491;&#22914; Hibernate &#25163;&#20876;&#25152;&#25551;&#36848;&#30340;&#37027;&#26679;
</li></ul></div>

<p>&#26412;&#33410;&#30340;&#20854;&#20313;&#37096;&#20998;&#25551;&#36848;&#20102;&#20107;&#20214;&#21457;&#29983;&#30340;&#39034;&#24207;&#21644; Hibernate &#23545; JTA <code class="literal">PlatformTransactionManager</code>&#30340;&#35748;&#30693;&#12290;</p>
<p>&#24403; Hibernate &#27809;&#26377;&#37197;&#32622;&#20219;&#20309; JTA <code class="literal">PlatformTransactionManager</code> &#30340;&#35748;&#30693;&#26102;,&#24403;&#19968;&#20010; JTA &#20107;&#21153;&#25552;&#20132;&#26102;&#20197;&#19979;&#20107;&#20214;&#21457;&#29983;:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
JTA &#20107;&#21153;&#25552;&#20132;&#12290;
</li><li class="listitem">
Spring &#30340; <code class="literal">JtaTransactionManager</code>&#19982; JTA &#20107;&#21153;&#21516;&#27493;&#26102;&#65292;&#36890;&#36807; JTA &#20107;&#21153;&#31649;&#29702;&#25191;&#34892;&#19968;&#20010; afterCompletion &#30340;&#22238;&#35843;&#12290;
</li><li class="listitem">
&#22312;&#20854;&#20182;&#27963;&#21160;&#20013;&#65292;&#20174; Spring &#21040; Hibernate &#30340;&#21516;&#27493;&#21487;&#20197;&#35302;&#21457;&#22238;&#35843;&#65292;&#36890;&#36807;Hibernate &#30340; <code class="literal">afterTransactionCompletion</code>&#22238;&#35843;&#65288;&#29992;&#20110;&#28165;&#38500; Hibernate &#32531;&#23384;&#65289;&#65292;&#38543;&#21518;&#30340;&#26159;&#19968;&#20010;&#26174;&#24335; close() &#35843;&#29992;&#22312; Hibernate Session,,&#23548;&#33268; Hibernate &#35797;&#22270;  close() JDBC &#36830;&#25509;&#12290;
</li><li class="listitem">
&#22312;&#26576;&#20123;&#29615;&#22659;&#20013;,&#36825;&#20010; <code class="literal">Connection.close()</code>&#35843;&#29992;&#28982;&#21518;&#35302;&#21457;&#35686;&#21578;&#25110;&#38169;&#35823;,&#22240;&#20026;&#24212;&#29992;&#31243;&#24207;&#26381;&#21153;&#22120;&#19981;&#20877;&#35748;&#20026;<code class="literal">Connection</code>&#26159;&#21487;&#29992;&#30340;,&#22240;&#20026;&#20107;&#21153;&#24050;&#32463;&#25552;&#20132;&#20102;&#12290;
</li></ul></div>

<p>&#24403;Hibernate &#37197;&#32622;&#20102; JTA <code class="literal">PlatformTransactionManager</code>&#30340;&#35748;&#30693;,&#24403;&#19968;&#20010;JTA&#20107;&#21153;&#25552;&#20132;&#65292;&#20197;&#19979;&#20107;&#20214;&#21457;&#29983;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
JTA &#20107;&#21153;&#20934;&#22791;&#25552;&#20132;&#12290;
</li><li class="listitem">
Spring &#30340; <code class="literal">JtaTransactionManager</code> &#36319; JTA &#20107;&#21153;&#26159;&#21516;&#27493;&#30340;,&#25152;&#20197;&#36890;&#36807; JTA &#20107;&#21153;&#31649;&#29702;&#22120;&#30340; <code class="literal">beforeCompletion</code>&#22238;&#35843;&#26469;&#25191;&#34892;&#20107;&#21153;&#30340;&#22238;&#35843;&#12290;
</li><li class="listitem">
Spring &#24863;&#30693;&#21040; Hibernate &#26412;&#36523;&#19982; JTA &#20107;&#21153;&#26159;&#21516;&#27493;&#30340;,&#24182;&#19988;&#34892;&#20026;&#19981;&#21516;&#20110;&#22312;&#21069;&#38754;&#30340;&#22330;&#26223;&#12290;&#20551;&#35774;&#38656;&#35201; Hibernate <code class="literal">Session</code>&#20851;&#38381;, &#37027;&#20040; Spring&#23558;&#20250;&#20851;&#38381;&#23427;&#12290;
</li><li class="listitem">
JTA &#20107;&#21153;&#25552;&#20132;
</li><li class="listitem">
Hibernate &#19982; JTA &#20107;&#21153;&#26159;&#21516;&#27493;&#30340;,&#25152;&#20197;&#36890;&#36807; JTA &#20107;&#21153;&#31649;&#29702;&#22120;&#30340; <code class="literal">beforeCompletion</code>&#22238;&#35843;&#26469;&#25191;&#34892;&#20107;&#21153;&#30340;&#22238;&#35843;&#65292;&#24182;&#33021;&#27491;&#30830;&#28165;&#26970;&#20854;&#32531;&#23384;&#12290;
</li></ul></div>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orm-jdo" href="#orm-jdo"></a>14.4&nbsp;JDO</h2></div></div></div>

<p>Spring &#25903;&#25345;&#26631;&#20934;&#30340; JDO 2.0 &#21644; 2.1 API &#30340;&#25968;&#25454;&#35775;&#38382;&#31574;&#30053;&#65292;&#25353;&#29031;&#19982; Hibernate &#21516;&#26679;&#30340;&#25903;&#25345;&#26041;&#24335;&#12290;&#30456;&#24212;&#30340;&#38598;&#25104;&#31867;&#39547;&#30041;&#22312;<code class="literal">org.springframework.orm.jdo</code> &#21253;&#12290;</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jdo-setup" href="#orm-jdo-setup"></a>14.4.1&nbsp;PersistenceManagerFactory &#35774;&#32622;</h3></div></div></div>

<p>Spring&#25552;&#20379; <code class="literal">LocalPersistenceManagerFactoryBean</code> &#31867;&#20801;&#35768;&#24744;&#22312;&#19968;&#20010; Spring &#24212;&#29992;&#19978;&#19979;&#25991;&#23450;&#20041;&#20102;&#19968;&#20010;&#23616;&#37096;&#30340; JDO &#30340;<code class="literal">PersistenceManagerFactory</code>&#65306;</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myPmf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jdo.LocalPersistenceManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"configLocation"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"classpath:kodo.properties"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#21478;&#22806;&#65292;&#20320;&#21487;&#20197;&#36890;&#36807;&#19968;&#20010; <code class="literal">PersistenceManagerFactory</code>&#23454;&#29616;&#31867;&#30340;&#30340;&#23454;&#20363;&#21270;&#26469;&#35774;&#32622; <code class="literal">PersistenceManagerFactory</code>&#12290;&#19968;&#20010; JDO &#30340;<code class="literal">PersistenceManagerFactory</code>&#23454;&#29616;&#31867;&#36981;&#24490; JavaBean &#27169;&#24335;&#65292;&#23601;&#20687;&#19968;&#20010;JDBC <code class="literal">DataSource</code> &#30340;&#23454;&#29616;&#31867;&#65292;&#36825;&#26159;&#22312; Spring &#37324;&#37197;&#32622;&#20351;&#29992;&#26159;&#38750;&#24120;&#21512;&#36866;&#30340;&#12290;&#36825;&#31181;&#35774;&#32622;&#26041;&#24335;&#36890;&#24120;&#25903;&#25345;&#19968;&#20010; Spring &#23450;&#20041;&#30340;JDBC <code class="literal">DataSource</code>&#65292;&#20256;&#36882;&#32473; <code class="literal">connectionFactory</code>&#12290;&#20363;&#22914;&#65292;&#23545;&#20110;&#24320;&#28304;&#30340; JDO &#23454;&#29616;DataNucleus (&#21407;&#21517; JPOX) ( <a class="ulink" href="http://www.datanucleus.org/" target="_top">http://www.datanucleus.org/</a>),
&#19979;&#38754;&#26159;<code class="literal">PersistenceManagerFactory</code>&#23454;&#29616;&#30340; XML &#37197;&#32622;&#65306;</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

 <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"driverClassName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.driverClassName}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"url"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.url}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"username"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.username}"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"password"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"${jdbc.password}"</span><span class="hl-tag">/&gt;</span>
 <span class="hl-tag">&lt;/bean&gt;</span>

 <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myPmf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.datanucleus.jdo.JDOPersistenceManagerFactory"</span> <span class="hl-attribute">destroy-method</span>=<span class="hl-value">"close"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"connectionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"nontransactionalRead"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
 <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#20063;&#21487;&#20197;&#22312;  Java EE &#24212;&#29992;&#26381;&#21153;&#30340; JNDI &#29615;&#22659;&#20013; &#35774;&#32622; JDO <code class="literal">PersistenceManagerFactory</code>&#65292;&#36890;&#24120;&#26159;&#36890;&#36807;  JCA &#36830;&#25509;&#22120;&#25552;&#20379;&#21253;&#21547; JDO &#30340;&#23454;&#29616;&#12290;Spring &#30340;&#26631;&#20934;&#20013; <code class="literal">JndiObjectFactoryBean</code> &#25110; <code class="literal">&lt;jee:jndi-lookup&gt;</code>&#21487;&#20197;&#29992;&#26469;&#26816;&#32034;&#21644;&#26292;&#38706;&#27604;&#22914;<code class="literal">PersistenceManagerFactory</code>&#12290;&#28982;&#32780;&#65292;&#22312; EJB &#19978;&#19979;&#25991; &#20043;&#22806;,&#27809;&#26377;&#30495;&#27491;&#30340;&#23384;&#22312;&#20110;&#22312; JNDI &#20013;&#20445;&#25345; <code class="literal">PersistenceManagerFactory</code> :&#21482;&#36873;&#25321;&#36825;&#26679;&#30340;&#19968;&#20010;&#35774;&#32622;&#26159;&#19968;&#20010;&#24456;&#22909;&#30340;&#29702;&#30001;&#12290;&#35831;&#21442;&#35265; <a class="xref" href="orm.html#orm-hibernate-resources" title="14.3.6&nbsp;&#27604;&#36739;&#23481;&#22120;&#31649;&#29702;&#21644;&#26412;&#22320;&#23450;&#20041;&#30340;&#36164;&#28304;">Section&nbsp;14.3.6, &#8220;&#27604;&#36739;&#23481;&#22120;&#31649;&#29702;&#21644;&#26412;&#22320;&#23450;&#20041;&#30340;&#36164;&#28304;&#8221;</a> for a discussion;
&#35752;&#35770;;&#37027;&#37324;&#30340;&#35770;&#28857;&#36866;&#29992;&#20110;JDO&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jdo-daos-straight" href="#orm-jdo-daos-straight"></a>14.4.2&nbsp;&#22522;&#20110;&#24179;&#24120;  JDO API &#30340; DAO &#30340;&#23454;&#29616;</h3></div></div></div>

<p>&#21033;&#29992;&#27880;&#20837;&#30340; <code class="literal">PersistenceManagerFactory</code>&#65292;&#20063;&#21487;&#20197;&#30452;&#25509;&#21033;&#29992;&#24179;&#24120;&#30340;JDO API&#26469;&#20889; DAO&#65292;&#32780;&#26080;&#38656; Spring &#30340;&#20381;&#36182;&#12290;&#20197;&#19979;&#26159;&#30456;&#24212;&#30340; DAO &#23454;&#29616;&#30340;&#19968;&#20010;&#20363;&#23376;&#65306;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">private</span> PersistenceManagerFactory persistenceManagerFactory;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setPersistenceManagerFactory(PersistenceManagerFactory pmf) {
        <span class="hl-keyword">this</span>.persistenceManagerFactory = pmf;
    }

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) {
        PersistenceManager pm = <span class="hl-keyword">this</span>.persistenceManagerFactory.getPersistenceManager();
        <span class="hl-keyword">try</span> {
            Query query = pm.newQuery(Product.<span class="hl-keyword">class</span>, <span class="hl-string">"category = pCategory"</span>);
            query.declareParameters(<span class="hl-string">"String pCategory"</span>);
            <span class="hl-keyword">return</span> query.execute(category);
        }
        <span class="hl-keyword">finally</span> {
            pm.close();
        }
    }
}</pre>

<p>&#22240;&#20026;&#19978;&#38754;&#30340; DAO &#20381;&#36182;&#27880;&#20837;&#27169;&#24335;&#65292;&#23427;&#36866;&#21512;&#22312; Spring &#23481;&#22120;&#20013;&#65292;&#23601;&#20687;&#22312;Spring &#30340; <code class="literal">JdoTemplate</code> &#20013;&#32534;&#30721;&#65306;</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmf"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#36825;&#26679;&#30340; DAO &#20027;&#35201;&#30340;&#38382;&#39064;&#26159;&#65292;&#20182;&#20204;&#24635;&#26159;&#20174;&#24037;&#21378;&#33719;&#24471;&#19968;&#20010;&#26032;&#30340;<code class="literal">PersistenceManager</code>&#12290;&#20026;&#20102;&#35775;&#38382; Spring &#31649;&#29702;&#30340;&#20107;&#21153; <code class="literal">PersistenceManager</code>&#65292;&#38656;&#35201;&#23450;&#20041;&#19968;&#20010;<code class="literal">TransactionAwarePersistenceManagerFactoryProxy</code>&#65288;&#21253;&#21547;&#22312;Spring &#20013;&#65289;&#22312;&#20320;&#30340;&#30446;&#26631; <code class="literal">PersistenceManagerFactory</code> &#38754;&#21069;&#65292;&#28982;&#21518;&#20256;&#36882;&#19968;&#20010;&#37027;&#20010;&#20195;&#29702;&#30340;&#24341;&#29992;&#21040;&#20320;&#30340; DAO&#65292;&#22914;&#19979;&#38754;&#30340;&#31034;&#20363;&#65306;</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myPmfProxy"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jdo.TransactionAwarePersistenceManagerFactoryProxy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetPersistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmf"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmfProxy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#20320;&#30340;&#25968;&#25454;&#35775;&#38382;&#20195;&#30721;&#23558;&#25910;&#21040;&#19968;&#20010;&#26469;&#33258; <code class="literal">PersistenceManagerFactory.getPersistenceManager()</code>&#35843;&#29992;&#30340;&#20107;&#21153;&#24615;&#30340;<code class="literal">PersistenceManager</code>&#65288;&#22914;&#26524;&#26377;&#65289;&#30340;&#26041;&#27861;&#12290;&#21518;&#32773;&#30340;&#26041;&#27861;&#30340;&#35843;&#29992;&#20250;&#36890;&#36807;&#20195;&#29702;&#65292;&#22312;&#20174;&#20174;&#24037;&#21378;&#33719;&#24471;&#19968;&#20010;&#26032;&#30340;&#20043;&#21069;&#23427;&#39318;&#20808;&#26816;&#26597;&#24403;&#21069;&#20107;&#21153;&#24615;&#30340;<code class="literal">PersistenceManager</code>&#12290;&#30001;&#20110; &#20107;&#21153;&#24615;&#30340;<code class="literal">PersistenceManager</code>&#65292;&#20219;&#20309; close() &#30340;&#35843;&#29992;&#23558;&#20250;&#34987;&#24573;&#30053;&#12290;</p>
<p>&#22914;&#26524;&#20320;&#30340;&#25968;&#25454;&#35775;&#38382;&#20195;&#30721;&#24635;&#26159;&#36816;&#34892;&#22312;&#19968;&#20010;&#27963;&#36291;&#30340;&#20107;&#21153;&#20013;&#65288;&#25110;&#33267;&#23569;&#19982;&#27963;&#36291;&#30340;&#20107;&#21153;&#21516;&#27493;&#65289;&#65292;&#23427;&#20250;&#23433;&#20840;&#30340;&#24573;&#30053; <code class="literal">PersistenceManager.close()</code>&#30340;&#35843;&#29992;&#12290;&#36825;&#26679;&#25972;&#20010;<code class="literal">finally</code>&#30340;&#22359;&#65292;&#21487;&#20197;&#35753;&#20320;&#30340; DAO &#23454;&#29616;&#26356;&#21152;&#31616;&#27905;&#65306;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">private</span> PersistenceManagerFactory persistenceManagerFactory;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setPersistenceManagerFactory(PersistenceManagerFactory pmf) {
        <span class="hl-keyword">this</span>.persistenceManagerFactory = pmf;
    }

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) {
        PersistenceManager pm = <span class="hl-keyword">this</span>.persistenceManagerFactory.getPersistenceManager();
        Query query = pm.newQuery(Product.<span class="hl-keyword">class</span>, <span class="hl-string">"category = pCategory"</span>);
        query.declareParameters(<span class="hl-string">"String pCategory"</span>);
        <span class="hl-keyword">return</span> query.execute(category);
    }
}</pre>

<p>&#30001;&#20110;&#36825;&#26679; DAO &#20381;&#26469;&#27963;&#21160;&#30340;&#20107;&#21153;&#65292;&#25152;&#26377;&#24314;&#35758;&#24744;&#36890;&#36807;&#20851;&#38381;<code class="literal">TransactionAwarePersistenceManagerFactoryProxy</code>&#30340; <code class="literal">allowCreate</code> &#26631;&#31614;&#26469;&#24378;&#21046;&#28608;&#27963;&#20107;&#21153;&#65306;</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myPmfProxy"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jdo.TransactionAwarePersistenceManagerFactoryProxy"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetPersistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmf"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"allowCreate"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmfProxy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#36825;&#31181; DAO &#39118;&#26684;&#30340;&#20027;&#35201;&#20248;&#21183;&#26159;,&#23427;&#21482;&#20381;&#36182;&#20110; JDO API;&#19981;&#38656;&#35201;&#24341;&#36827;&#20219;&#20309;&#30340;Spring &#31867;&#12290;&#20174;&#38750;&#20405;&#20837;&#24615;&#30340;&#35282;&#24230;&#26469;&#35828;&#26356;&#21560;&#24341;&#20154;&#65292;&#24182;&#19988;&#23545;&#20110; JDO &#24320;&#21457;&#20154;&#21592;&#26469;&#35828;&#21487;&#33021;&#20250;&#35273;&#24471;&#26356;&#33258;&#28982;&#12290;</p>
<p>&#28982;&#32780;,DAO &#25243;&#20986;&#24179;&#24120;&#30340; <code class="literal">JDOException</code>(&#26410;&#26816;&#26597;&#30340;,&#22240;&#27492;&#19981;&#38656;&#35201;&#22768;&#26126;&#25110;&#25429;&#33719;),&#36825;&#24847;&#21619;&#30528;&#35843;&#29992;&#32773;&#21482;&#33021;&#23558;&#24322;&#24120;&#24403;&#20570;&#26159;&#33268;&#21629;&#30340;,&#38500;&#38750;&#20320;&#24819;&#20381;&#38752; JDO &#30340;&#24322;&#24120;&#32467;&#26500;&#12290;&#25429;&#25417;&#20048;&#35266;&#38145;&#22833;&#36133;&#31561;&#29305;&#27530;&#21407;&#22240;&#26159;&#19981;&#21487;&#33021;&#65292;&#38500;&#38750;&#25226;&#35843;&#29992;&#32773;&#19982;&#23454;&#29616;&#31574;&#30053;&#30456;&#20851;&#32852;&#12290;&#21462;&#28040;&#36825;&#20132;&#26131;&#21487;&#33021;&#20250;&#26356;&#23481;&#26131;&#21463;&#24212;&#29992;&#31243;&#24207;&#25509;&#21463;&#65292;&#22240;&#20026;&#22522;&#20110; JDO &#21644;/&#25110; &#19981;&#38656;&#35201;&#20219;&#20309;&#29305;&#27530;&#30340;&#24322;&#24120;&#22788;&#29702;&#12290;</p>
<p>&#24635;&#20043;,&#20320;&#21487;&#20197;&#26681;&#25454;&#24179;&#24120;&#30340; JDO API &#29983;&#20135; DAO ,&#20182;&#20204;&#20173;&#28982;&#21487;&#20197;&#21442;&#19982; Spring&#31649;&#29702;&#20107;&#21153;&#12290;&#36825;&#31574;&#30053;&#20250;&#21487;&#33021;&#20250;&#21560;&#24341;&#20320;&#22914;&#26524;&#20320;&#24050;&#32463;&#29087;&#24713;&#20102; JDO&#12290;&#28982;&#32780;,&#36825;&#26679;&#30340;DAO &#25243;&#20986;&#24179;&#24120;&#30340; <code class="literal">JDOException</code>,&#24744;&#24517;&#39035;&#26174;&#24335;&#22320;&#36716;&#25442;&#20026; Spring &#30340;<code class="literal">DataAccessException</code>(&#22914;&#26524;&#38656;&#35201;)&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jdo-tx" href="#orm-jdo-tx"></a>14.4.3&nbsp;Transaction management</h3></div></div></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>&#22914;&#26524;&#20320;&#36824;&#27809;&#26377;&#30475;&#36807; <a class="xref" href="transaction.html#transaction-declarative" title="11.5&nbsp;Declarative transaction management">Section&nbsp;11.5, &#8220;Declarative transaction management&#8221;</a> &#24378;&#28872;&#24314;&#35758;&#20320;&#30475;&#19979;&#65292;&#33719;&#21462;&#26356;&#22810;Spring &#22768;&#26126;&#24335;&#20107;&#21153;&#30340;&#25903;&#25345;.</p>
</td></tr></table></div>

<p>&#25191;&#34892;&#26381;&#21153;&#30340;&#20107;&#21153;&#25805;&#20316;&#65292;&#20351;&#29992; Spring &#24120;&#35265;&#30340;&#22768;&#26126;&#24335;&#20107;&#21153;&#21151;&#33021;&#65292;&#20030;&#20363;&#65306;</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTxManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jdo.JdoTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myPmf"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"productDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myProductDao"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"txManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;tx:attributes&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"increasePrice*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someOtherBusinessMethod"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRES_NEW"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"SUPPORTS"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/tx:attributes&gt;</span>
    <span class="hl-tag">&lt;/tx:advice&gt;</span>

    <span class="hl-tag">&lt;aop:config&gt;</span>
        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"productServiceMethods"</span>
                <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* product.ProductService.*(..))"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"productServiceMethods"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/aop:config&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>JDO &#38656;&#35201;&#19968;&#20010;&#27963;&#21160;&#30340;&#20107;&#21153;&#26469;&#20462;&#25913;&#25345;&#20037;&#21270;&#30340;&#23545;&#35937;&#12290;&#38750;&#20107;&#21153;&#24615;&#30340;&#21047;&#26032;&#27010;&#24565;&#24182;&#19981;&#23384;&#22312;&#20110; JDO&#65292;&#30456;&#23545;&#20110; Hibernate&#12290;&#20026;&#27492;&#65292;&#20320;&#38656;&#35201;&#20026;&#29305;&#23450;&#30340;&#29615;&#22659;&#35774;&#32622;&#36873;&#25321;&#30340;JDO &#30340;&#23454;&#29616;&#12290;&#20855;&#20307;&#26469;&#35828;&#65292;&#20320;&#38656;&#35201;&#35774;&#32622;&#26126;&#30830;&#30340; JTA &#21516;&#27493;&#65292;&#26469;&#26816;&#27979;&#19968;&#20010;&#27963;&#36291;&#30340;JTA &#20107;&#21153;&#26412;&#36523;&#12290;&#36825;&#23545;&#20110; Spring &#30340; <code class="literal">JdoTransactionManager</code>&#25191;&#34892;&#30340;&#26412;&#22320;&#20107;&#21153;&#26469;&#35828;&#26159;&#27809;&#26377;&#24517;&#35201;&#30340;&#65292;&#20294;&#26377;&#24517;&#35201;&#21442;&#19982; JTA &#20107;&#21153;&#65292;&#19981;&#31649;&#26159;&#30001; Spring <code class="literal">JtaTransactionManager</code>&#39537;&#21160; &#36824;&#26159; EJB CMT &#21644;&#26222;&#36890;&#30340; JTA&#12290;</p>
<p><code class="literal">JdoTransactionManager</code>&#33021;&#22815;&#20351; JDO &#20107;&#21153; JDBC &#35775;&#38382;&#20195;&#30721;f&#35775;&#38382;&#21516;&#19968;&#20010;JDBC`DataSource`&#65292;&#25552;&#20379;&#27880;&#20876;&#30340; <code class="literal">JdoDialect</code> &#25903;&#25345;&#24213;&#23618;&#30340; JDBC ` Connection`&#26816;&#32034;&#12290;&#36825;&#26159;&#40664;&#35748;&#24773;&#20917;&#19979;&#22522;&#20110;JDBC &#30340; JDO 2.0&#23454;&#29616;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jdo-dialect" href="#orm-jdo-dialect"></a>14.4.4&nbsp;JdoDialect</h3></div></div></div>

<p>&#20316;&#20026;&#19968;&#20010;&#39640;&#32423;&#21151;&#33021;,<code class="literal">JdoTemplate</code> &#21644;<code class="literal">JdoTransactionManager</code>&#25903;&#25345;&#33258;&#23450;&#20041;<code class="literal">JdoDialect</code>&#21487;&#20197;&#20256;&#36882;&#21040;<code class="literal">JdoDialect</code>&#30340; bean &#23646;&#24615;&#12290;&#22312;&#36825;&#20010;&#22330;&#26223;&#20013;,DAO &#19981;&#25509;&#21463; <code class="literal">PersistenceManagerFactory</code>&#30340;&#24341;&#29992;,&#32780;&#26159;&#19968;&#20010;&#23436;&#25972;&#30340;<code class="literal">JdoTemplate</code>&#23454;&#20363;(&#20363;&#22914;,&#20256;&#36882;&#21040;<code class="literal">JdoDaoSupport</code>&#30340;&#23646;&#24615;<code class="literal">JdoTemplate</code> &#20013;)&#12290;&#20351;&#29992;<code class="literal">JdoDialect</code>&#23454;&#29616;,&#24744;&#21487;&#20197;&#21551;&#29992; Spring &#30340;&#39640;&#32423;&#29305;&#24615;&#25903;&#25345;,&#36890;&#24120;&#29305;&#23450;&#20110;&#20379;&#24212;&#21830;&#30340;&#26041;&#24335;:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
&#24212;&#29992;&#20110;&#29305;&#23450;&#30340;&#20107;&#21153;&#35821;&#20041;,&#22914;&#33258;&#23450;&#20041;&#38548;&#31163;&#32423;&#21035;&#25110;&#20107;&#21153;&#36229;&#26102;
</li><li class="listitem">
&#26816;&#32034;&#20107;&#21153;&#24615;&#30340; JDBC <code class="literal">Connection</code>,&#29992;&#26469;&#26292;&#38706;&#22522;&#20110; JDBC &#30340; DAO
</li><li class="listitem">
&#24212;&#29992;&#26597;&#35810;&#36229;&#26102;,&#33258;&#21160;&#20174; Spring &#31649;&#29702;&#20107;&#21153;&#36229;&#26102;&#36827;&#34892;&#35745;&#31639;
</li><li class="listitem">
&#21450;&#26102;&#21047;&#26032; <code class="literal">PersistenceManager</code>,&#20351;&#20107;&#21153;&#21464;&#21270;&#23545;&#20110;&#22522;&#20110; JDBC &#30340;&#25968;&#25454;&#35775;&#38382;&#20195;&#30721;&#21487;&#35265;
</li><li class="listitem">
&#20174; <code class="literal">JDOExceptions</code> &#21521; Spring     <code class="literal">DataAccessExceptions</code>&#30340;&#39640;&#32423;&#36716;&#25442;
</li></ul></div>

<p>&#26597;&#30475; <code class="literal">JdoDialect</code> &#30340; javadocs &#33719;&#21462;&#26356;&#22810;&#22914;&#26524;&#20351;&#29992; Spring JDO &#30340;&#32454;&#33410;</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="orm-jpa" href="#orm-jpa"></a>14.5&nbsp;JPA</h2></div></div></div>

<p>Spring JPA,&#23384;&#22312;&#19982; <code class="literal">org.springframework.orm.jpa</code> &#21253;&#65292;&#25552;&#20379;&#26041;&#20415;&#30340;&#23545;&#20110;
<a class="ulink" href="http://www.oracle.com/technetwork/articles/javaee/jpa-137156.html" target="_top">Java Persistence
API</a> &#30340;&#31867;&#20284;&#20110; Hibernate &#25110;&#32773; JDO &#30340;&#25903;&#25345;&#65292;&#20026;&#20102;&#35299;&#24213;&#23618;&#30340;&#23454;&#29616;&#65292;&#25552;&#20379;&#39069;&#22806;&#30340;&#21151;&#33021;&#12290;</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jpa-setup" href="#orm-jpa-setup"></a>14.5.1&nbsp;&#19977;&#31181;&#35774;&#32622;&#36873;&#39033;</h3></div></div></div>

<p>Spring JPA &#25552;&#20379;&#19977;&#31181;&#26041;&#24335;&#26469;&#35774;&#32622;  JPA <code class="literal">EntityManagerFactory</code> &#29992;&#20110;&#24212;&#29992;&#31243;&#24207;&#23454;&#29616;&#23454;&#20307;&#30340;&#31649;&#29702;&#12290;</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="orm-jpa-setup-lemfb" href="#orm-jpa-setup-lemfb"></a>LocalEntityManagerFactoryBean</h4></div></div></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>&#21482;&#22312;&#31616;&#21333;&#37096;&#32626;&#29615;&#22659;&#20013;&#65292;&#27604;&#22914;&#29420;&#31435;&#30340;&#24212;&#29992;&#31243;&#24207;&#21644;&#38598;&#25104;&#27979;&#35797;&#25165;&#20351;&#29992;&#35813;&#36873;&#39033;</p>
</td></tr></table></div>

<p><code class="literal">LocalEntityManagerFactoryBean</code> &#21019;&#24314;&#20102;&#19968;&#20010;&#20165;&#20351;&#29992; JPA &#35775;&#38382;&#25968;&#25454;&#36866;&#21512;&#37096;&#32626;&#22312;&#31616;&#21333;&#29615;&#22659;&#19979;&#30340;&#24212;&#29992;&#31243;&#24207;&#30340; <code class="literal">EntityManagerFactory</code>&#12290;&#24037;&#21378; bean &#20351;&#29992; JPA <code class="literal">PersistenceProvider</code> &#33258;&#21160;&#26816;&#27979;&#26426;&#21046;&#65288;&#26681;&#25454; JPA &#30340;Java SE &#24341;&#23548;&#65289;&#65292;&#22312;&#22823;&#22810;&#25968;&#24773;&#20917;&#19979;&#65292;&#38656;&#35201;&#25351;&#23450;&#21807;&#19968;&#25345;&#20037;&#21333;&#20803;&#21517;&#31216;&#65306;</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myEmf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.LocalEntityManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceUnitName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myPersistenceUnit"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#36825;&#31181;&#24418;&#24335;&#30340; JPA &#30340;&#37096;&#32626;&#26159;&#26368;&#31616;&#21333;&#21644;&#26368;&#26377;&#38480;&#30340;&#12290;&#20320;&#19981;&#33021;&#24341;&#29992;&#29616;&#26377;&#30340; JDBC <code class="literal">DataSource</code> &#30340; bean &#30340;&#23450;&#20041;&#65292;&#24182;&#19988;&#19981;&#25903;&#25345;&#20840;&#23616;&#20107;&#21153;&#30340;&#23384;&#22312;&#12290;&#27492;&#22806;&#65292;&#32455;&#20837;&#65288;&#23383;&#33410;&#30721;&#36716;&#25442;&#65289;&#25345;&#20037;&#21270;&#31867;&#26159;&#25552;&#20379;&#32773;&#29305;&#23450;&#30340;&#65292;&#24448;&#24448;&#38656;&#35201;&#19968;&#20010;&#29305;&#23450;&#30340; JVM &#20195;&#29702;&#22312;&#21551;&#21160;&#26102;&#25351;&#23450;&#12290;&#27492;&#36873;&#39033;&#20165;&#36866;&#29992;&#20110;&#20026; JPA &#35268;&#33539;&#35774;&#35745;&#30340;&#29420;&#31435;&#30340;&#24212;&#29992;&#31243;&#24207;&#21644;&#27979;&#35797;&#29615;&#22659;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="orm-jpa-setup-jndi" href="#orm-jpa-setup-jndi"></a>&#20174; JNDI &#20013;&#33719;&#24471; EntityManagerFactory</h4></div></div></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>&#24403;&#37096;&#32626;&#22312; Java EE 5 &#26381;&#21153;&#22120;&#20013;&#20351;&#29992;&#35813;&#36873;&#39033;&#65292;&#26597;&#30475;&#20320;&#30340;&#26381;&#21153;&#22120;&#30340;&#25991;&#26723;&#26469;&#33719;&#30693;&#22914;&#20309;&#37096;&#32626;&#33258;&#23450;&#20041;&#30340; JPA &#25552;&#20379;&#32773; &#22312;&#20320;&#30340;&#26381;&#21153;&#22120;&#20013;&#65292;&#20801;&#35768;&#19981;&#21516;&#20110;&#26381;&#21153;&#22120;&#40664;&#35748;&#30340;&#25552;&#20379;&#32773;&#12290;</p>
</td></tr></table></div>

<p>&#20174; JNDI &#20013;&#33719;&#24471; <code class="literal">EntityManagerFactory</code> (&#20030;&#20363; &#22312; Java EE 5 &#29615;&#22659;&#20013;)&#65292;&#21482;&#38656;&#31616;&#21333;&#37197;&#32622; XML:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myEmf"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"persistence/myPersistenceUnit"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#36825;&#20010;&#21160;&#20316;&#25351;&#23450;&#26631;&#20934;&#30340; Java EE 5 &#30340;&#24341;&#23548;&#65306; Java EE&#26381;&#21153;&#22120;&#33258;&#21160;&#26816;&#27979;&#25345;&#20037;&#21333;&#20803;&#65288;&#23454;&#38469;&#19978;&#65292;<code class="literal">META-INF/persistence.xml</code>&#25991;&#20214;&#22312;&#24212;&#29992;&#30340; jar &#20013;&#65289;&#21644;&#22312;Java EE&#37096;&#32626;&#25551;&#36848;&#31526;&#20013;&#30340; <code class="literal">persistence-unit-ref</code> &#30340;&#23454;&#20307;&#65288;&#20363;&#22914;&#65292;web.xml&#65289;&#24182;&#20026;&#36825;&#20123;&#23450;&#20041;&#29615;&#22659;&#21629;&#21517;&#19978;&#19979;&#25991;&#30340;&#20301;&#32622;&#12290;</p>
<p>&#22312;&#36825;&#31181;&#24773;&#20917;&#19979;&#65292;&#25972;&#20010;&#25345;&#20037;&#21270;&#21333;&#20803;&#30340;&#37096;&#32626;&#65292;&#21253;&#25324;&#32455;&#20837;&#65288;&#23383;&#33410;&#30721;&#36716;&#25442;&#65289;&#25345;&#20037;&#21270;&#31867;&#65292;&#21040; Java EE &#26381;&#21153;&#22120;&#12290;JDBC <code class="literal">DataSource</code>&#26159;&#36890;&#36807; JNDI &#20301;&#32622;&#23450;&#20041;&#22312;META-INF/persistence.xml&#25991;&#20214;&#20013;&#12290;EntityManager &#20107;&#21153;&#38598;&#25104;&#22312;&#26381;&#21153;&#22120;&#30340; JTA &#23376;&#31995;&#32479;&#20013;&#12290;Spring &#21482;&#26159;&#20351;&#29992;&#33719;&#24471;&#30340; <code class="literal">EntityManagerFactory</code>&#65292;&#36890;&#36807;&#20381;&#36182;&#27880;&#20837;&#20256;&#36882;&#32473;&#24212;&#29992;&#31243;&#24207;&#23545;&#35937;&#65292;&#24182;&#19988;&#20026;&#25345;&#20037;&#21333;&#20803;&#31649;&#29702;&#20107;&#21153;&#65292;&#36890;&#24120;&#26159;&#36890;&#36807; <code class="literal">JtaTransactionManager</code>&#12290;</p>
<p>&#22914;&#26524;&#22810;&#20010;&#25345;&#20037;&#21333;&#20803;&#20013;&#20351;&#29992;&#30456;&#21516;&#30340;&#24212;&#29992;&#31243;&#24207;&#65292; JNDI&#26816;&#32034;&#30340;&#25345;&#20037;&#21333;&#20803;&#30340; bean &#21517;&#31216;&#24212;&#19982;&#25345;&#20037;&#21333;&#20803;&#30340;&#21517;&#31216;&#21305;&#37197;&#65292;&#24212;&#29992;&#31243;&#24207;&#24341;&#29992;&#23427;&#20204;&#65292;&#27604;&#22914;&#65292;&#22312;<code class="literal">@PersistenceUnit</code> &#21644; <code class="literal">@PersistenceContext</code>&#27880;&#35299;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="orm-jpa-setup-lcemfb" href="#orm-jpa-setup-lcemfb"></a>LocalContainerEntityManagerFactoryBean</h4></div></div></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>&#22312;&#22522;&#20110; Spring &#30340;&#20351;&#29992; JPA &#20840;&#21151;&#33021;&#30340;&#24212;&#29992;&#29615;&#22659;&#20013;&#65292;&#20351;&#29992;&#35813;&#36873;&#39033;&#12290;&#36825;&#20010;&#21253;&#21547;&#20102; web &#23481;&#22120;&#20320;&#27604;&#22914; Tomcat &#20316;&#20026;&#20855;&#26377;&#22797;&#26434;&#30340;&#25345;&#32493;&#24615;&#35201;&#27714;&#30340;&#21333;&#29420;&#30340;&#24212;&#29992;&#21644;&#38598;&#25104;&#27979;&#35797;</p>
</td></tr></table></div>

<p><code class="literal">LocalContainerEntityManagerFactoryBean</code>&#32473;<code class="literal">EntityManagerFactory</code>&#23436;&#20840;&#25511;&#21046;&#37197;&#32622;&#21644;&#25353;&#38656;&#23450;&#21046;&#32454;&#31890;&#24230;&#30340;&#36866;&#21512;&#30340;&#29615;&#22659;&#12290;<code class="literal">LocalContainerEntityManagerFactoryBean</code>&#21019;&#24314;&#22522;&#20110; ` persistence.xml`&#25991;&#20214; &#30340; <code class="literal">PersistenceUnitInfo</code>&#30340;&#23454;&#20363;,&#25552;&#20379;<code class="literal">dataSourceLookup</code>&#30340;&#31574;&#30053;,&#25351;&#23450;<code class="literal">loadTimeWeaver</code>&#12290;&#22240;&#27492;&#21487;&#20197;&#22312; JNDI &#22806;&#37096;&#20351;&#29992;&#33258;&#23450;&#20041;&#25968;&#25454;&#28304;&#21644;&#25511;&#21046;&#32534;&#32455;&#36807;&#31243;&#12290;&#19979;&#38754;&#30340;&#31034;&#20363;&#26174;&#31034;&#20102;&#19968;&#20010;&#20856;&#22411;&#30340;&#23450;&#20041;<code class="literal">LocalContainerEntityManagerFactoryBean</code>&#30340; bean:</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myEmf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"someDataSource"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"loadTimeWeaver"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.instrument.classloading.InstrumentationLoadTimeWeaver"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#19979;&#38754;&#23637;&#31034;&#24120;&#35265;&#30340; persistence.xml &#65306;</p>
<pre class="programlisting"><span class="hl-tag">&lt;persistence</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://java.sun.com/xml/ns/persistence"</span> <span class="hl-attribute">version</span>=<span class="hl-value">"1.0"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;persistence-unit</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myUnit"</span> <span class="hl-attribute">transaction-type</span>=<span class="hl-value">"RESOURCE_LOCAL"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;mapping-file&gt;</span>META-INF/orm.xml<span class="hl-tag">&lt;/mapping-file&gt;</span>
        <span class="hl-tag">&lt;exclude-unlisted-classes/&gt;</span>
    <span class="hl-tag">&lt;/persistence-unit&gt;</span>
<span class="hl-tag">&lt;/persistence&gt;</span></pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">&lt;exclude-unlisted-classes/&gt;</code>&#24555;&#25463;&#34920;&#26126;&#24212;&#35813;&#20986;&#29616;&#26410;&#25195;&#25551;&#30340;&#27880;&#35299;&#30340;&#23454;&#20307;&#31867;&#12290;&#19968;&#20010;&#26126;&#30830;&#30340; true &#20540;&#25351;&#23450;<code class="literal">&lt;exclude-unlisted-classes&gt;true&lt;/exclude-unlisted-classes/&gt;</code> &#20063;&#24847;&#21619;&#30528;&#27809;&#26377;&#25195;&#25551;&#12290;<code class="literal">&lt;exclude-unlisted-classes&gt;false&lt;/exclude-unlisted-classes/&gt; d</code>&#35302;&#21457;&#25195;&#25551;&#65307;&#28982;&#32780;&#65292;&#23427;&#26159;&#24314;&#35758;&#24178;&#33030;&#30465;&#30053; <code class="literal">exclude-unlisted-classes</code>&#20803;&#32032;&#22914;&#26524;&#20320;&#24819;&#25195;&#25551;&#20135;&#29983;&#30340;&#23454;&#20307;&#31867;&#12290;</p>
</td></tr></table></div>

<p>&#20351;&#29992; <code class="literal">LocalContainerEntityManagerFactoryBean</code> &#26159;&#26368;&#24378;&#22823;&#30340; JPA &#35774;&#32622;&#36873;&#39033;&#65292;&#20801;&#35768;&#20016;&#23500;&#30340;&#22312;&#24212;&#29992;&#20013;&#26412;&#22320;&#37197;&#32622;&#12290;&#23427;&#25903;&#25345;&#36830;&#25509;&#21040;&#29616;&#26377;&#30340;  JDBC <code class="literal">DataSource</code>,&#25903;&#25345; &#21253;&#25324; &#26412;&#22320;&#21644;&#20840;&#23616;&#30340;&#20107;&#21153;&#65292;&#31561;&#31561;&#12290;&#28982;&#32780;,&#23427;&#36824;&#23545;&#36816;&#34892;&#26102;&#29615;&#22659;&#30340;&#26377;&#29305;&#27530;&#30340;&#38656;&#27714;,&#27604;&#22914;&#38656;&#35201; weaving-capable&#65288;&#21487;&#32455;&#20837;&#30340;&#65289;&#30340;&#31867;&#36733;&#20837;&#22120;&#65292;&#24403;&#25345;&#20037;&#24615;&#25552;&#20379;&#32773;&#35201;&#27714;&#23383;&#33410;&#30721;&#36716;&#25442;&#26102;&#12290;</p>
<p>&#27492;&#36873;&#39033;&#21487;&#33021; Java EE 5 &#26381;&#21153;&#22120;&#20013;&#20869;&#32622; JPA &#21151;&#33021;&#20914;&#31361;&#12290;&#22312;&#19968;&#20010;&#23436;&#25972;&#30340; Java EE 5 &#30340;&#29615;&#22659;&#19979;,&#32771;&#34385;&#20174; JNDI &#33719;&#21462;&#20320;&#30340;<code class="literal">EntityManagerFactory</code>&#12290;&#21478;&#22806;,<code class="literal">LocalContainerEntityManagerFactoryBean</code>&#23450;&#20041;&#20013;&#25351;&#23450;&#19968;&#20010;&#33258;&#23450;&#20041; <code class="literal">persistenceXmlLocation</code> ,&#20363;&#22914;, META-INF/my-persistence.xml ,&#24182;&#19988;&#21482;&#21253;&#21547;&#19968;&#20010;&#25551;&#36848;&#31526;,&#36825;&#20010;&#21517;&#23383;&#22312;&#20320;&#30340;&#24212;&#29992;&#31243;&#24207; jar &#25991;&#20214;&#12290;&#22240;&#20026; Java EE 5 &#26381;&#21153;&#22120;&#21482;&#26597;&#25214;&#40664;&#35748;<code class="literal">META-INF/persistence.xml</code>&#25991;&#20214;,&#23427;&#24573;&#30053;&#20102;&#36825;&#20123;&#33258;&#23450;&#20041;&#25345;&#20037;&#24615;&#21333;&#20803;,&#20174;&#32780;&#36991;&#20813;&#19982; Spring &#39537;&#21160;&#30340; JPA &#39044;&#20808;&#35774;&#32622;&#20914;&#31361;&#12290;(&#20363;&#22914;,&#36825;&#36866;&#29992;&#20110; Resin 3.1)&#12290;</p>
<div class="sidebar"><div class="titlepage"><div><div><p class="title"><b>&#20160;&#20040;&#26102;&#20505;&#38656;&#35201;&#36733;&#20837;&#26102;&#32455;&#20837;?</b></p></div></div></div>

<p>&#19981;&#26159;&#25152;&#26377;&#30340; JPA &#25552;&#20379;&#32773;&#38656;&#35201; JVM &#20195;&#29702;;Hibernate &#23601;&#26159;&#36825;&#26679;&#30340;&#19968;&#20010;&#20363;&#23376;&#12290;&#22914;&#26524;&#20320;&#30340;&#25552;&#20379;&#32773;&#19981;&#38656;&#35201;&#19968;&#20010;&#20195;&#29702;&#25110;&#20320;&#26377;&#20854;&#20182;&#36873;&#25321;,&#22914;&#24212;&#29992;&#22686;&#24378;&#22312;&#26500;&#24314;&#26102;&#36890;&#36807;&#19968;&#20010;&#33258;&#23450;&#20041;&#30340;&#32534;&#35793;&#22120;&#25110;&#19968;&#20010; ant &#20219;&#21153;,&#27492;&#26102;&#19981;&#24212;&#20351;&#29992;&#36733;&#20837;&#26102;&#32455;&#20837;&#12290;</p>
</div>

<p><code class="literal">LoadTimeWeaver</code>&#25509;&#21475;&#26159;&#19968;&#20010; Spring &#31867;,&#20801;&#35768;&#23558; JPA <code class="literal">ClassTransformer</code>&#23454;&#20363;&#25554;&#20837;&#19968;&#20010;&#29305;&#23450;&#30340;&#26041;&#24335;,&#36825;&#21462;&#20915;&#20110;&#29615;&#22659;&#26159; web &#23481;&#22120;&#25110;&#24212;&#29992;&#31243;&#24207;&#26381;&#21153;&#22120;&#12290;&#36890;&#36807;&#19968;&#20010;
<a class="ulink" href="http://docs.oracle.com/javase/6/docs/api/java/lang/instrument/package-summary.html" target="_top">agent</a>
&#26469;&#25346;&#38057; <code class="literal">ClassTransformers</code>&#36890;&#24120;&#26159;&#26080;&#25928;&#30340;&#12290;&#20195;&#29702;&#24037;&#20316;&#22312;&#25972;&#20010;&#34394;&#25311;&#26426;&#24182;&#26816;&#26597;&#27599;&#19968;&#20010;&#21152;&#36733;&#31867;,&#36890;&#24120;&#26159;&#22312;&#29983;&#20135;&#26381;&#21153;&#22120;&#29615;&#22659;&#20013;&#19981;&#21463;&#27426;&#36814;&#30340;&#12290;</p>
<p>Spring &#25552;&#20379;&#20102;&#35768;&#22810; <code class="literal">LoadTimeWeaver</code> &#21508;&#31181;&#29615;&#22659;&#30340;&#23454;&#29616;,&#20801;&#35768;<code class="literal">ClassTransformer</code>&#23454;&#20363;&#20165;&#36866;&#29992;&#20110;&#27599;&#20010;&#31867;&#35013;&#20837;&#22120;,&#32780;&#19981;&#26159;&#27599;&#20010; VM&#12290;</p>
<p>&#21442;&#32771; AOP &#31456;&#33410; <a class="xref" href="aop.html#aop-aj-ltw-spring" title="Spring configuration">the section called &#8220;Spring configuration&#8221;</a> &#20102;&#35299;&#20851;&#20110;<code class="literal">LoadTimeWeaver</code>&#23454;&#29616;&#21450;&#20854;&#35774;&#32622;,&#21253;&#25324;&#27867;&#22411;&#25110;&#23450;&#21046;&#21508;&#31181;&#24179;&#21488;(&#22914; Tomcat&#12289;WebLogic&#12289;GlassFish&#12289;Resin &#21644;JBoss)&#12290;</p>
<p>&#22914;&#19978;&#36848;&#25152;&#36848;&#37096;&#20998;,&#24744;&#21487;&#20197;&#37197;&#32622;&#19968;&#20010;context-wide&#65288;&#23485;&#27867;&#19978;&#19979;&#25991;&#30340;&#65289; <code class="literal">LoadTimeWeaver</code>&#20351;&#29992;<code class="literal">context:load-time-weaver</code>&#20803;&#32032;&#20013;&#30340;<code class="literal">@EnableLoadTimeWeaving</code>&#27880;&#37322;&#12290;&#36825;&#26679;&#19968;&#20010;&#20840;&#29699;&#32455;&#20837;&#26159;&#25152;&#26377; JPA <code class="literal">LocalContainerEntityManagerFactoryBeans</code>&#33258;&#21160;&#25429;&#25417;&#21040;&#12290;&#36825;&#26159;&#35774;&#32622;&#21152;&#36733;&#26102;&#32455;&#20837;&#30340;&#39318;&#36873;&#26041;&#27861;,&#33021;&#33258;&#21160;&#35782;&#21035;&#20986;&#24179;&#21488;(WebLogic, GlassFish, Tomcat, Resin, JBoss &#25110;&#32773; VM &#20195;&#29702;)&#21644;&#33258;&#21160;&#20256;&#25773;&#30340;&#32455;&#20837;&#21040;&#25152;&#26377;&#21487;&#32455;&#20837;&#30340; bean &#20013;:</p>
<pre class="programlisting"><span class="hl-tag">&lt;context:load-time-weaver/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
    ...
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>&#19981;&#36807;,&#22914;&#26524;&#38656;&#35201;,&#21487;&#20197;&#25163;&#21160;&#36890;&#36807; <code class="literal">loadTimeWeaver&#23646;&#24615;</code>&#25351;&#23450;&#19968;&#20010;&#19987;&#38376;&#30340;&#32455;&#20837;:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"loadTimeWeaver"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.instrument.classloading.ReflectiveLoadTimeWeaver"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>&#26080;&#35770; LTW &#22914;&#20309;&#37197;&#32622;,&#20351;&#29992;&#36825;&#31181;&#25216;&#26415;,JPA &#24212;&#29992;&#31243;&#24207;&#20381;&#36182;&#20110;&#22120;&#21487;&#20197;&#36816;&#34892;&#22312;&#30446;&#26631;&#24179;&#21488;(&#20363;:Tomcat)&#32780;&#19981;&#38656;&#35201;&#20195;&#29702;&#30340;&#22522;&#30784;&#35774;&#26045;&#12290;&#36825;&#26159;&#38750;&#24120;&#37325;&#35201;&#30340;,&#23588;&#20854;&#26159;&#24403;&#25176;&#31649;&#30340;&#24212;&#29992;&#31243;&#24207;&#20381;&#36182;&#20110;&#19981;&#21516;&#30340; JPA &#23454;&#29616;&#65292;&#22240;&#20026; JPA &#36716;&#25442;&#22120;&#21482;&#22312;&#31867;&#35013;&#20837;&#22120;&#32423;&#21035;,&#22240;&#27492;&#24444;&#27492;&#26159;&#38548;&#31163;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="orm-jpa-multiple-pu" href="#orm-jpa-multiple-pu"></a>&#22788;&#29702;&#22810;&#20010;&#25345;&#20037;&#21333;&#20803;</h4></div></div></div>

<p>&#23545;&#20110;&#20381;&#36182;&#20110;&#22810;&#20010;&#25345;&#20037;&#21333;&#20803;&#30340;&#20301;&#32622;&#30340;&#24212;&#29992;&#31243;&#24207;&#65292;&#22312;&#31867;&#36335;&#24452;&#20013;&#65292;&#23384;&#20648;&#22312;&#19981;&#21516;&#30340;JAR &#20013;&#65292;&#20363;&#22914;&#65292;Spring &#25552;&#20379;<code class="literal">PersistenceUnitManager</code>&#20316;&#20026;&#20013;&#22830;&#23384;&#20648;&#24211;&#65292;&#20197;&#36991;&#20813;&#25345;&#20037;&#21333;&#20803;&#30340;&#21457;&#29616;&#36807;&#31243;&#65292;&#23427;&#21487;&#20197;&#26159;&#26114;&#36149;&#30340;&#12290;&#40664;&#35748;&#30340;&#23454;&#29616;&#20801;&#35768;&#22810;&#20010;&#20301;&#32622;&#34987;&#25351;&#23450;&#65292;&#31245;&#21518;&#34987;&#36890;&#36807;&#25345;&#20037;&#21333;&#20803;&#21517;&#31216;&#26816;&#32034;&#12290;&#65288;&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#36335;&#24452;&#25628;&#32034;&#30340;&#30340;&#26159;META-INF/persistence.xml &#25991;&#20214;&#12290;&#65289;</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"pum"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.persistenceunit.DefaultPersistenceUnitManager"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceXmlLocations"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>org/springframework/orm/jpa/domain/persistence-multi.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>classpath:/my/package/**/custom-persistence.xml<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>classpath*:META-INF/persistence.xml<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dataSources"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;map&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"localDataSource"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"local-db"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;entry</span> <span class="hl-attribute">key</span>=<span class="hl-value">"remoteDataSource"</span> <span class="hl-attribute">value-ref</span>=<span class="hl-value">"remote-db"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/map&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-comment">&lt;!-- if no datasource is specified, use this one --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"defaultDataSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"remoteDataSource"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"emf"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceUnitManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"pum"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"persistenceUnitName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myCustomUnit"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>&#40664;&#35748;&#30340;&#23454;&#29616;&#20801;&#35768;&#30340;&#33258;&#23450;&#20041; <code class="literal">PersistenceUnitInfo</code> &#23454;&#20363;&#65292;&#22312;&#20182;&#20204;&#20256;&#20837; JPA &#25552;&#20379;&#32773;&#20043;&#21069;&#65292;&#22768;&#26126;&#36890;&#36807;&#23427;&#30340;&#23646;&#24615;&#65292;&#24433;&#21709;&#25152;&#26377;&#30340;&#21333;&#20803;&#65292;&#25110;&#20197;&#32534;&#31243;&#26041;&#24335;&#65292;&#36890;&#36807; <code class="literal">PersistenceUnitPostProcessor</code>&#65292;&#20801;&#35768;&#25345;&#20037;&#21333;&#20803;&#30340;&#36873;&#25321;&#12290;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#19968;&#20010; <code class="literal">PersistenceUnitManager</code>&#65292;&#30001;<code class="literal">LocalContainerEntityManagerFactoryBean</code>&#20869;&#37096;&#21019;&#24314;&#21644;&#20351;&#29992;&#12290;</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jpa-straight" href="#orm-jpa-straight"></a>14.5.2&nbsp;&#22522;&#20110;&#24179;&#24120; JPA&#30340; DAO &#30340;&#23454;&#29616;</h3></div></div></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>&#34429;&#28982; <code class="literal">EntityManagerFactory</code> &#23454;&#20363;&#26159;&#32447;&#31243;&#23433;&#20840;&#30340; , &#20294; <code class="literal">EntityManager</code> &#19981;&#26159;&#12290;&#27880;&#20837;&#30340; JPA <code class="literal">EntityManager</code> &#30340;&#34892;&#20026;&#20687;&#19968;&#20010; &#20174;&#24212;&#29992;&#26381;&#21153;&#22120;&#30340; JNDI &#29615;&#22659;&#20013;&#36890;&#36807; JPA &#35268;&#33539;&#23450;&#20041;&#30340; <code class="literal">EntityManager</code> &#12290;&#23427;&#20195;&#34920;&#25152;&#26377;&#35843;&#29992;&#24403;&#21069;&#20107;&#21153;<code class="literal">EntityManager</code>&#65292;&#22914;&#26524;&#26159;&#30340;&#35805;&#65307;&#21542;&#21017;&#65292;&#23427;&#22312;&#27599;&#27425;&#25805;&#20316;&#26102;&#36820;&#22238;&#26032;&#21019;&#24314;&#30340;<code class="literal">EntityManager</code>&#65292;&#20351;&#20854;&#32447;&#31243;&#23433;&#20840;&#12290;</p>
</td></tr></table></div>

<p>&#36890;&#36807;&#27880;&#20837;<code class="literal">EntityManagerFactory</code> &#25110; <code class="literal">EntityManager</code>&#65292;&#23545;&#20110;&#32534;&#20889;&#24179;&#24120; JPA &#20195;&#30721;&#23545; Spring &#27809;&#26377;&#20219;&#20309;&#20381;&#36182;&#12290; Spring &#21487;&#20197;&#29702;&#35299;<code class="literal">@PersistenceUnit</code>&#21644;<code class="literal">@PersistenceContext</code>&#21644;&#27880;&#35299;&#22312;&#23383;&#27573;&#21644;&#26041;&#27861;&#23618;&#38754;&#65292;&#22914;&#26524;&#21551;&#21160; <code class="literal">PersistenceAnnotationBeanPostProcessor</code>&#30340;&#35805;&#12290;&#26222;&#36890;&#30340;JPA DAO&#23454;&#29616;&#20351;&#29992; <code class="literal">@PersistenceUnit</code>&#27880;&#35299;&#21487;&#33021;&#30475;&#36215;&#26469;&#20687;&#36825;&#26679;:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <span class="hl-keyword">private</span> EntityManagerFactory emf;

    <em><span class="hl-annotation" style="color: gray">@PersistenceUnit</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setEntityManagerFactory(EntityManagerFactory emf) {
        <span class="hl-keyword">this</span>.emf = emf;
    }

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) {
        EntityManager em = <span class="hl-keyword">this</span>.emf.createEntityManager();
        <span class="hl-keyword">try</span> {
            Query query = em.createQuery(<span class="hl-string">"from Product as p where p.category = ?1"</span>);
            query.setParameter(<span class="hl-number">1</span>, category);
            <span class="hl-keyword">return</span> query.getResultList();
        }
        <span class="hl-keyword">finally</span> {
            <span class="hl-keyword">if</span> (em != null) {
                em.close();
            }
        }
    }
}</pre>

<p>&#19978;&#38754;&#30340; DAO &#27809;&#26377;&#20381;&#36182; Spring ,&#20294; &#20219;&#28982;&#38750;&#24120;&#31526;&#21512; Spring &#24212;&#29992;&#30340;&#19978;&#19979;&#25991;&#12290;&#27492;&#22806;&#65292;&#35813; DAO &#20805;&#20998;&#21033;&#29992; <code class="literal">EntityManagerFactory</code> &#40664;&#35748;&#27880;&#35299;&#65306;</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-comment">&lt;!-- bean post-processor for JPA annotations --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#20316;&#20026;&#19968;&#31181;&#26126;&#30830;&#26367;&#20195;&#23450;&#20041; <code class="literal">PersistenceAnnotationBeanPostProcessor</code>&#65292;&#32771;&#34385;&#20351;&#29992; Spring  <code class="literal">context:annotation-config</code>  &#22312;&#20320;&#30340;&#24212;&#29992;&#31243;&#24207;&#29615;&#22659;&#37197;&#32622;&#12290;&#36825;&#26679;&#20570;&#33258;&#21160;&#27880;&#20876;&#25152;&#26377;&#30340; Spring &#22522;&#20110;&#27880;&#37322;&#30340;&#37197;&#32622;&#26631;&#20934;&#22788;&#29702;&#22120;&#65292;&#21253;&#25324;<code class="literal">CommonAnnotationBeanPostProcessor</code>&#31561;&#31561;&#12290;</p>
<pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-comment">&lt;!-- post-processors for all standard config annotations --&gt;</span>
    <span class="hl-tag">&lt;context:annotation-config/&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductDao"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductDaoImpl"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>&#36825;&#26679;&#30340; DAO &#30340;&#20027;&#35201;&#30340;&#38382;&#39064;&#26159;&#65292;&#23427;&#24635;&#26159;&#36890;&#36807;&#24037;&#21378;&#21019;&#24314;&#19968;&#20010;&#26032;&#30340; <code class="literal">EntityManager</code> &#12290;&#20320;&#21487;&#20197;&#35831;&#27714;&#19968;&#20010;&#20107;&#21153;<code class="literal">EntityManager</code>&#65288;&#20063;&#34987;&#31216;&#20026;&#8220;&#20849;&#20139; EntityManager &#8221;&#22240;&#20026;&#23427;&#26159;&#19968;&#20010;&#20849;&#20139;&#30340;&#65292;&#32447;&#31243;&#23433;&#20840;&#30340;&#20195;&#29702;&#22312;&#23454;&#38469;&#20107;&#21153; EntityManager &#20013;&#65289;&#34987;&#27880;&#20837;&#32780;&#19981;&#26159;&#24037;&#21378;&#26469;&#36991;&#20813;&#36825;&#31181;&#24773;&#20917;&#65306;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductDaoImpl <span class="hl-keyword">implements</span> ProductDao {

    <em><span class="hl-annotation" style="color: gray">@PersistenceContext</span></em>
    <span class="hl-keyword">private</span> EntityManager em;

    <span class="hl-keyword">public</span> Collection loadProductsByCategory(String category) {
        Query query = em.createQuery(<span class="hl-string">"from Product as p where p.category = :category"</span>);
        query.setParameter(<span class="hl-string">"category"</span>, category);
        <span class="hl-keyword">return</span> query.getResultList();
    }
}</pre>

<p><code class="literal">@PersistenceContext</code>&#27880;&#35299;&#26377;&#20010;&#21487;&#36873;&#23646;&#24615;<code class="literal">type</code>, &#40664;&#35748;&#20540;&#26159;` PersistenceContextType.TRANSACTION` &#12290;&#40664;&#35748;&#30340;&#26159;&#20320;&#38656;&#35201;&#25509;&#25910;&#20849;&#20139;&#30340;<code class="literal">EntityManager</code>&#20195;&#29702;&#12290;<code class="literal">PersistenceContextType.EXTENDED</code>&#65292;&#26159;&#19968;&#20010;&#23436;&#20840;&#19981;&#21516;&#30340;&#20107;&#24773;,&#36825;&#20010;&#32467;&#26524;&#23545; <code class="literal">EntityManager</code>&#30340;&#25193;&#23637;&#65292;&#23427;&#19981;&#26159;&#32447;&#31243;&#23433;&#20840;&#30340;&#65292;&#22240;&#27492;&#19981;&#33021;&#29992;&#20110;&#24182;&#21457;&#35775;&#38382;&#30340;&#32452;&#20214;&#22914; Spring &#31649;&#29702;&#21333;&#20363; bean&#12290;&#25193;&#23637;&#30340; EntityManager &#21482;&#33021;&#29992;&#22312;&#26377;&#29366;&#24577;&#30340;&#32452;&#20214;&#65292;&#20363;&#22914;&#65292;&#39547;&#30041;&#22312;&#19968;&#20010;&#20250;&#35805;&#19978;&#65292;&#36825;&#26679;EntityManager &#30340;&#29983;&#21629;&#21608;&#26399;&#19981;&#20381;&#36182;&#20110;&#24403;&#21069;&#20107;&#21153;&#65292;&#32780;&#26159;&#23436;&#20840;&#21462;&#20915;&#20110;&#24212;&#29992;&#31243;&#24207;&#12290;</p>
<div class="sidebar"><div class="titlepage"><div><div><p class="title"><b>Method- and field-level Injection</b></p></div></div></div>

<p>&#27880;&#37322;&#34920;&#26126;&#20381;&#36182;&#27880;&#20837;&#65288;&#22914; <code class="literal">@PersistenceUnit</code> &#21644; <code class="literal">@PersistenceContext</code>&#65289;&#21487;&#24212;&#29992;&#20110;&#31867;&#20013;&#30340;&#23383;&#27573;&#25110;&#26041;&#27861;&#65292;&#22240;&#27492;&#34920;&#29616;&#26041;&#27861;&#32423;&#21035;&#30340;&#27880;&#20837;&#21644;&#23383;&#27573;&#32423;&#21035;&#30340;&#27880;&#20837;&#12290;&#23383;&#27573;&#32423;&#21035;&#30340;&#27880;&#20837;&#26159;&#31616;&#27905;&#21644;&#23481;&#26131;&#20351;&#29992;&#32780;&#26041;&#27861;&#32423;&#21035;&#20801;&#35768;&#36827;&#19968;&#27493;&#22788;&#29702;&#27880;&#20837;&#30340;&#20381;&#36182;&#12290;&#22312;&#36825;&#20004;&#31181;&#24773;&#20917;&#19979;&#30340;&#25104;&#21592;&#21487;&#35265;&#24615;&#65288;&#20844;&#20849;&#65292;&#20445;&#25252;&#65292;&#31169;&#20154;&#65289;&#19981;&#35201;&#32039;&#12290;</p>
<p>&#37027;&#31867;&#32423;&#21035;&#30340;&#27880;&#20837;&#21602;&#65311;</p>
<p>&#22312; Java EE 5 &#24179;&#21488;&#65292;&#23427;&#20204;&#26159;&#29992;&#26469;&#22768;&#26126;&#20381;&#36182;&#32780;&#19981;&#26159;&#36164;&#28304;&#27880;&#20837;</p>
</div>

<p>&#27880;&#20837;<code class="literal">EntityManager</code>&#26159; Spring &#31649;&#29702;&#30340;&#65288;&#24847;&#35782;&#21040;&#27491;&#22312;&#36827;&#34892;&#30340;&#20107;&#21153;&#65289;&#12290;&#38656;&#35201;&#27880;&#24847;&#30340;&#26159;&#65292;&#23613;&#31649;&#26032;&#30340; DAO &#23454;&#29616;&#20351;&#29992;&#19968;&#20010; <code class="literal">EntityManager</code> &#26041;&#27861;&#27880;&#20837;&#32780;&#19981;&#26159;&#19968;&#20010;<code class="literal">EntityManagerFactory</code>&#65292;&#22312;&#24212;&#29992;&#31243;&#24207;&#19978;&#19979;&#25991;&#30340; XML &#27880;&#37322;&#30340;&#29992;&#27861;&#26080;&#38656;&#25913;&#21464;&#12290;</p>
<p>&#36825;&#31181; DAO &#39118;&#26684;&#30340;&#20027;&#35201;&#20248;&#28857;&#26159;&#65292;&#23427;&#19981;&#20165;&#21462;&#20915;&#20110; Java Persistence API;&#65288;Java &#25345;&#20037;&#24615;API&#65289;&#65292;&#32780;&#26080;&#38656;&#24341;&#36827;&#20219;&#20309; Spring &#30340;&#31867;&#12290;&#27492;&#22806;&#65292;&#20316;&#20026; JPA &#27880;&#37322;&#26356;&#23481;&#26131;&#29702;&#35299;&#65292;&#27880;&#35299;&#21487;&#20197;&#34987; Spring &#23481;&#22120;&#33258;&#21160;&#24212;&#29992;&#12290;&#36825;&#26159;&#20174;&#38750;&#20405;&#34989;&#24615;&#30340;&#30340;&#35282;&#24230;&#30475;&#24456;&#20855;&#26377;&#21560;&#24341;&#21147;&#65292;&#23545;&#20110; JPA &#30340;&#24320;&#21457;&#20154;&#21592;&#26469;&#35828;&#21487;&#33021;&#24863;&#35273;&#26356;&#33258;&#28982;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jpa-tx" href="#orm-jpa-tx"></a>14.5.3&nbsp;&#20107;&#21153;&#31649;&#29702;</h3></div></div></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>&#22914;&#26524;&#20320;&#36824;&#27809;&#26377;&#30475;&#36807; <a class="xref" href="transaction.html#transaction-declarative" title="11.5&nbsp;Declarative transaction management">Section&nbsp;11.5, &#8220;Declarative transaction management&#8221;</a> &#24378;&#28872;&#24314;&#35758;&#20320;&#30475;&#19979;&#65292;&#33719;&#21462;&#26356;&#22810;Spring &#22768;&#26126;&#24335;&#20107;&#21153;&#30340;&#25903;&#25345;*</p>
</td></tr></table></div>

<p>&#25191;&#34892;&#26381;&#21153;&#30340;&#20107;&#21153;&#25805;&#20316;&#65292;&#20351;&#29992; Spring &#24120;&#35265;&#30340;&#22768;&#26126;&#24335;&#20107;&#21153;&#21151;&#33021;&#65292;&#20030;&#20363;&#65306;</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:aop</span>=<span class="hl-value">"http://www.springframework.org/schema/aop"</span>
    <span class="hl-attribute">xmlns:tx</span>=<span class="hl-value">"http://www.springframework.org/schema/tx"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myTxManager"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.jpa.JpaTransactionManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"entityManagerFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myEmf"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myProductService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"product.ProductServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"productDao"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"myProductDao"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;aop:config&gt;</span>
        <span class="hl-tag">&lt;aop:pointcut</span> <span class="hl-attribute">id</span>=<span class="hl-value">"productServiceMethods"</span> <span class="hl-attribute">expression</span>=<span class="hl-value">"execution(* product.ProductService.*(..))"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;aop:advisor</span> <span class="hl-attribute">advice-ref</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">pointcut-ref</span>=<span class="hl-value">"productServiceMethods"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/aop:config&gt;</span>

    <span class="hl-tag">&lt;tx:advice</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txAdvice"</span> <span class="hl-attribute">transaction-manager</span>=<span class="hl-value">"myTxManager"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;tx:attributes&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"increasePrice*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRED"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someOtherBusinessMethod"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"REQUIRES_NEW"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;tx:method</span> <span class="hl-attribute">name</span>=<span class="hl-value">"*"</span> <span class="hl-attribute">propagation</span>=<span class="hl-value">"SUPPORTS"</span> <span class="hl-attribute">read-only</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/tx:attributes&gt;</span>
    <span class="hl-tag">&lt;/tx:advice&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<p>Spring &#30340; JPA &#20801;&#35768;&#37197;&#32622; <code class="literal">JpaTransactionManager</code>&#26469;&#26292;&#38706; JPA &#20107;&#21153;&#32473; JDBC &#35775;&#38382;&#20195;&#30721;&#20174;&#32780;&#33021;&#22815;&#35775;&#38382;&#21516;&#19968;&#20010; JDBC <code class="literal">DataSource</code>&#25552;&#20379;&#27880;&#20876;<code class="literal">JpaDialect</code>&#25903;&#25345;&#24213;&#23618;&#30340; JDBC <code class="literal">Connection</code>&#26816;&#32034;&#12290;&#24320;&#31665;&#21363;&#29992;&#65292;Spring &#25552;&#20379;&#20102; TopLink &#65292;Hibernate &#21644; OpenJPA &#30340; JPA &#23454;&#29616;&#30340;&#26041;&#35328;&#12290;&#35831;&#21442;&#38405;&#19979;&#19968;&#33410; <code class="literal">JpaDialect</code>&#26426;&#21046;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="orm-jpa-dialect" href="#orm-jpa-dialect"></a>14.5.4&nbsp;JpaDialect</h3></div></div></div>

<p>&#20316;&#20026;&#19968;&#20010;&#39640;&#32423;&#21151;&#33021; <code class="literal">JpaTemplate</code>,<code class="literal">JpaTransactionManager `&#21644;`AbstractEntityManagerFactoryBean</code>&#23376;&#31867;&#25903;&#25345;&#33258;&#23450;&#20041; JpaDialect,&#20256;&#36882;&#21040; <code class="literal">JpaDialect</code> bean &#23646;&#24615;&#12290;&#22312;&#36825;&#31181;&#24773;&#20917;&#19979;,DAO &#26410;&#24471;&#21040;<code class="literal">EntityManagerFactory</code>&#30340;&#24341;&#29992;,&#32780;&#26159;&#19968;&#20010;&#23436;&#25972;&#30340;<code class="literal">JpaTemplate</code>&#23454;&#20363;(&#20363;&#22914;,&#20256;&#36882;&#21040;<code class="literal">JpaDaoSupport</code>&#30340;<code class="literal">JpaTemplate</code> &#23646;&#24615;)&#12290;<code class="literal">JpaDialect</code>&#23454;&#29616;&#21487;&#20197;&#20351;&#19968;&#20123; Spring &#25903;&#25345;&#30340;&#39640;&#32423;&#21151;&#33021;,&#36890;&#24120;&#21462;&#20915;&#20110;&#29305;&#23450;&#20379;&#24212;&#21830;&#30340;&#26041;&#24335;:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
&#24212;&#29992;&#29305;&#23450;&#30340;&#20107;&#21153;&#35821;&#20041;,&#22914;&#33258;&#23450;&#20041;&#38548;&#31163;&#32423;&#21035;&#25110;&#20107;&#21153;&#36229;&#26102;)
</li><li class="listitem">
&#26816;&#32034;&#20107;&#21153;&#26292;&#38706;&#20110;&#22522;&#20110; JDBC &#30340; DAO &#30340; JDBC <code class="literal">Connection</code>)
</li><li class="listitem">
<code class="literal">PersistenceExceptions</code> &#21040; Spring <code class="literal">DataAccessExceptions</code>&#30340;&#39640;&#32423;&#36716;&#25442;
</li></ul></div>

<p>&#36825;&#23545;&#20110;&#29305;&#27530;&#20107;&#21153;&#35821;&#20041;&#21644;&#39640;&#32423;&#30340;&#24322;&#24120;&#36716;&#25442;&#26469;&#35828;&#26159;&#38750;&#24120;&#26377;&#20215;&#20540;&#30340;&#12290;&#40664;&#35748;&#23454;&#29616;&#20351;&#29992;(<code class="literal">DefaultJpaDialect</code>)&#19981;&#25552;&#20379;&#20219;&#20309;&#29305;&#27530;&#21151;&#33021;,&#22914;&#26524;&#38656;&#35201;&#19978;&#38754;&#30340;&#21151;&#33021;,&#20320;&#24517;&#39035;&#25351;&#23450;&#36866;&#24403;&#30340;&#26041;&#35328;&#12290;</p>
<p>&#26597;&#30475; <code class="literal">JpaDialect</code> &#30340; javadocs &#33719;&#21462;&#26356;&#22810;&#22914;&#26524;&#20351;&#29992; Spring JPA &#30340;&#32454;&#33410;</p>
</div>
</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="jdbc.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="spring-data-tier.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="oxm.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">13.&nbsp;Data access with JDBC&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;15.&nbsp;Marshalling XML using O/X Mappers</td></tr></table></div></body></html>